<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google" content="notranslate">
  <meta name="robots" content="noindex, nofollow">
  <title>Kunden-Manager - CLARITY Glasfaser Termin-Management</title>
  <link rel="stylesheet" href="./css/styles.css">
  <style>
    .manager-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }
    
    .manager-header {
      margin-bottom: 32px;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }

    .header-text {
      flex: 1;
      text-align: left;
    }

    .language-selector {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .lang-btn {
      padding: 8px 12px;
      border: 2px solid #2c4a5e;
      background: #173140;
      color: var(--text);
      border-radius: 10px;
      cursor: pointer;
      font-size: 1.1rem;
      transition: all 0.3s ease;
    }

    .lang-btn:hover {
      border-color: var(--accent);
      background: rgba(34, 197, 94, 0.1);
    }

    .lang-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #04131c;
    }
    
    .manager-header h1 {
      margin: 0 0 8px;
      font-size: 2.2rem;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .manager-header p {
      color: var(--muted);
      font-size: 1.1rem;
      margin: 0;
    }
    
    /* Controles mejorados */
    .controls-section {
      background: var(--card);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }
    
    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
    }
    
    .control-group label {
      font-size: 0.9rem;
      color: var(--text);
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .control-group select,
    .control-group input {
      padding: 12px 16px;
      border-radius: 12px;
      border: 2px solid #2c4a5e;
      background: #173140;
      color: var(--text);
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }
    
    .control-group select:focus,
    .control-group input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
    }
    
    .quick-filters {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #2c4a5e;
    }
    
    .quick-filter-btn {
      padding: 8px 16px;
      border-radius: 20px;
      border: 2px solid #2c4a5e;
      background: #173140;
      color: var(--text);
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .quick-filter-btn:hover {
      border-color: var(--accent);
      background: rgba(34, 197, 94, 0.1);
    }
    
    .quick-filter-btn.active {
      background: var(--accent);
      color: #04131c;
      border-color: var(--accent);
    }
    
    .quick-filter-btn.status-103 {
      border-color: #f59e0b;
      background: rgba(245, 158, 11, 0.1);
      color: #f59e0b;
    }
    
    .quick-filter-btn.status-103.active {
      background: #f59e0b;
      color: #04131c;
    }
    
    /* Acciones masivas mejoradas */
    .bulk-actions {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
      align-items: center;
      flex-wrap: wrap;
      background: var(--card);
      padding: 16px 20px;
      border-radius: 12px;
    }
    
    .bulk-actions button {
      background: #173140;
      color: var(--text);
      border: 2px solid #2c4a5e;
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .bulk-actions button:hover:not(:disabled) {
      border-color: var(--accent);
      transform: translateY(-2px);
    }
    
    .bulk-actions button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
    }
    
    .bulk-actions button.primary {
      background: linear-gradient(135deg, #13ce66, #16a34a);
      color: #04131c;
      border-color: var(--accent);
    }
    
    .bulk-actions button.danger {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border-color: #ef4444;
    }
    
    .bulk-actions button.integration {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
      border-color: #8b5cf6;
    }
    
    .bulk-actions button.team-action {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: #451a03;
      border-color: #f59e0b;
    }
    
    /* Panel de integraci√≥n */
    .integration-panel {
      background: var(--card);
      border-radius: 16px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      border: 2px solid #8b5cf6;
      overflow: hidden;
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
    }
    
    .panel-header h3 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 600;
    }
    
    .close-panel {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 6px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }
    
    .close-panel:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .panel-content {
      padding: 24px;
    }
    
    .integration-status {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
      padding: 16px;
      background: #0f1b23;
      border-radius: 12px;
    }
    
    .status-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .status-label {
      font-size: 0.85rem;
      color: var(--muted);
      font-weight: 500;
    }
    
    .status-value {
      font-size: 0.95rem;
      color: var(--text);
      font-weight: 600;
    }
    
    .status-value.connected {
      color: #22c55e;
    }
    
    .sync-options {
      margin-bottom: 24px;
    }
    
    .sync-options h4 {
      margin: 0 0 16px;
      color: var(--text);
      font-size: 1rem;
      font-weight: 600;
    }
    
    .checkbox-option {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      cursor: pointer;
      color: var(--muted);
      font-size: 0.9rem;
    }
    
    .checkbox-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #8b5cf6;
    }
    
    .sync-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .sync-btn,
    .test-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
    }
    
    .sync-btn {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #052e16;
    }
    
    .test-btn {
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
      border: 2px solid #3b82f6;
    }
    
    .sync-btn:hover,
    .test-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }
    
    /* Panel de asignaci√≥n de equipos */
    .team-assignment-panel {
      background: var(--card);
      border-radius: 16px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      border: 2px solid #f59e0b;
      overflow: hidden;
      animation: slideDown 0.3s ease;
    }
    
    .team-assignment-panel .panel-header {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: #451a03;
    }
    
    .assignment-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
      padding: 16px;
      background: #0f1b23;
      border-radius: 12px;
    }
    
    .summary-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .summary-label {
      font-size: 0.85rem;
      color: var(--muted);
      font-weight: 500;
    }
    
    .summary-value {
      font-size: 1.2rem;
      color: var(--text);
      font-weight: 700;
    }
    
    .team-selection {
      margin-bottom: 24px;
    }
    
    .team-selection h4,
    .assignment-options h4,
    .assignment-preview h4 {
      margin: 0 0 16px;
      color: var(--text);
      font-size: 1rem;
      font-weight: 600;
    }
    
    .team-options {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .team-option {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .team-option label {
      font-size: 0.9rem;
      color: var(--text);
      font-weight: 600;
    }
    
    .team-option select {
      padding: 12px 16px;
      border-radius: 8px;
      border: 2px solid #2c4a5e;
      background: #173140;
      color: var(--text);
      font-size: 0.95rem;
      cursor: pointer;
    }
    
    .team-option select:focus {
      outline: none;
      border-color: #f59e0b;
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
    }
    
    .technicians-list {
      margin-top: 16px;
      padding: 16px;
      background: rgba(245, 158, 11, 0.05);
      border-radius: 12px;
      border: 1px solid rgba(245, 158, 11, 0.2);
    }
    
    .technicians-list h5 {
      margin: 0 0 12px;
      color: var(--text);
      font-size: 0.9rem;
      font-weight: 600;
    }
    
    .technicians-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
    }
    
    .technician-card {
      background: var(--card);
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid #2c4a5e;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .technician-name {
      font-weight: 600;
      color: var(--text);
      font-size: 0.9rem;
    }
    
    .technician-info {
      font-size: 0.8rem;
      color: var(--muted);
    }
    
    .technician-workload {
      font-size: 0.8rem;
      color: #f59e0b;
      font-weight: 600;
    }
    
    .technician-efficiency {
      font-size: 0.8rem;
      color: #22c55e;
      font-weight: 600;
    }
    
    .technician-plz {
      font-size: 0.7rem;
      color: var(--muted);
      margin-top: 4px;
      padding: 2px 6px;
      background: rgba(169, 192, 207, 0.1);
      border-radius: 4px;
    }

    /* Gesti√≥n expandida de t√©cnicos */
    .resource-management {
      background: var(--card);
      border-radius: 16px;
      margin-bottom: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      border: 2px solid #06b6d4;
      overflow: hidden;
    }

    .resource-management .panel-header {
      background: linear-gradient(135deg, #06b6d4, #0891b2);
      color: white;
    }

    .resource-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      padding: 20px;
      background: #0f1b23;
      margin: 20px;
      border-radius: 12px;
    }

    .resource-card {
      background: var(--card);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #2c4a5e;
      text-align: center;
    }

    .resource-card h4 {
      margin: 0 0 8px 0;
      font-size: 0.9rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .resource-value {
      font-size: 2rem;
      font-weight: 700;
      margin: 8px 0;
      color: var(--text);
    }

    .resource-trend {
      font-size: 0.8rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .trend-up {
      color: #22c55e;
    }

    .trend-down {
      color: #ef4444;
    }

    .trend-neutral {
      color: #f59e0b;
    }

    .teams-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      padding: 20px;
    }

    .team-card {
      background: var(--card);
      border: 2px solid #2c4a5e;
      border-radius: 16px;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .team-card:hover {
      border-color: #06b6d4;
      box-shadow: 0 8px 24px rgba(6, 182, 212, 0.15);
    }

    .team-header {
      background: linear-gradient(135deg, #1e293b, #334155);
      padding: 16px 20px;
      border-bottom: 1px solid #2c4a5e;
    }

    .team-name {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text);
      margin: 0 0 4px 0;
    }

    .team-region {
      font-size: 0.85rem;
      color: var(--muted);
      margin: 0;
    }

    .team-stats {
      display: flex;
      justify-content: space-between;
      padding: 12px 20px;
      background: rgba(6, 182, 212, 0.05);
      border-bottom: 1px solid rgba(6, 182, 212, 0.1);
    }

    .stat-item {
      text-align: center;
    }

    .stat-label {
      font-size: 0.7rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--text);
    }

    .efficiency-high {
      color: #22c55e;
    }

    .efficiency-medium {
      color: #f59e0b;
    }

    .efficiency-low {
      color: #ef4444;
    }

    .workload-high {
      color: #ef4444;
    }

    .workload-medium {
      color: #f59e0b;
    }

    .workload-low {
      color: #22c55e;
    }

    .technicians-list-expanded {
      padding: 0;
    }

    .technician-row {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid #2c4a5e;
      transition: all 0.2s ease;
    }

    .technician-row:hover {
      background: rgba(6, 182, 212, 0.05);
    }

    .technician-row:last-child {
      border-bottom: none;
    }

    .tech-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #06b6d4, #0891b2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 1.1rem;
      margin-right: 16px;
    }

    .tech-info {
      flex: 1;
      min-width: 0;
    }

    .tech-name {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text);
      margin: 0 0 4px 0;
    }

    .tech-specialty {
      font-size: 0.8rem;
      color: var(--muted);
      margin: 0;
    }

    .tech-metrics {
      display: flex;
      gap: 16px;
      align-items: center;
      margin-left: 16px;
    }

    .metric-badge {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      min-width: 60px;
    }

    .metric-label {
      font-size: 0.7rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .metric-value {
      font-size: 0.85rem;
      font-weight: 700;
      margin-top: 2px;
    }

    .workload-bar {
      width: 80px;
      height: 6px;
      background: #2c4a5e;
      border-radius: 3px;
      margin-top: 4px;
      overflow: hidden;
    }

    .workload-fill {
      height: 100%;
      border-radius: 3px;
      transition: all 0.3s ease;
    }

    .efficiency-circle {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
      border: 2px solid;
    }

    .resource-actions {
      display: flex;
      gap: 12px;
      padding: 20px;
      border-top: 1px solid #2c4a5e;
      flex-wrap: wrap;
    }

    .resource-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      font-size: 0.9rem;
    }

    .resource-btn.view-details {
      background: rgba(6, 182, 212, 0.1);
      color: #06b6d4;
      border: 2px solid #06b6d4;
    }

    .resource-btn.optimize {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #052e16;
    }

    .resource-btn.schedule {
      background: rgba(245, 158, 11, 0.1);
      color: #f59e0b;
      border: 2px solid #f59e0b;
    }

    .resource-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }

    .resource-filters {
      display: flex;
      gap: 12px;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #2c4a5e;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .filter-label {
      font-size: 0.8rem;
      color: var(--muted);
      font-weight: 600;
    }

    .filter-select {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #2c4a5e;
      background: #173140;
      color: var(--text);
      font-size: 0.85rem;
    }

    .alert-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #ef4444;
      color: white;
      font-size: 0.7rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .performance-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .performance-excellent {
      background: rgba(34, 197, 94, 0.1);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .performance-good {
      background: rgba(34, 197, 94, 0.1);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .performance-average {
      background: rgba(245, 158, 11, 0.1);
      color: #f59e0b;
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .performance-poor {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }
    
    .assignment-options {
      margin-bottom: 24px;
    }
    
    .assignment-preview {
      margin-bottom: 24px;
    }
    
    .preview-content {
      background: #0f1b23;
      border-radius: 12px;
      padding: 16px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .preview-assignment {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #2c4a5e;
    }
    
    .preview-assignment:last-child {
      border-bottom: none;
    }
    
    .preview-tech {
      font-weight: 600;
      color: var(--text);
    }
    
    .preview-count {
      color: #f59e0b;
      font-weight: 600;
    }
    
    .assignment-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .preview-btn,
    .confirm-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
    }
    
    .preview-btn {
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
      border: 2px solid #3b82f6;
    }
    
    .confirm-btn {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #052e16;
    }
    
    .preview-btn:hover,
    .confirm-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }
    
    .preview-btn:disabled,
    .confirm-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .selection-info {
      background: linear-gradient(135deg, #203646, #173140);
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 600;
      border: 1px solid #2c4a5e;
    }
    
    /* Tabla mejorada */
    .table-section {
      background: var(--card);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }
    
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid #2c4a5e;
    }
    
    .table-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text);
    }
    
    .sort-controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .sort-select {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #2c4a5e;
      background: #173140;
      color: var(--text);
      font-size: 0.9rem;
    }
    
    .table-container {
      overflow-x: auto;
      max-height: 600px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 16px 12px;
      text-align: left;
      border-bottom: 1px solid #2c4a5e;
    }
    
    th {
      background: #1a3540;
      color: var(--text);
      position: sticky;
      top: 0;
      z-index: 2;
      font-weight: 600;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    th:first-child {
      width: 60px;
      text-align: center;
    }
    
    th.sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
    }
    
    th.sortable:hover {
      background: #203646;
    }
    
    th.sortable::after {
      content: '‚Üï';
      margin-left: 8px;
      opacity: 0.5;
    }
    
    th.sort-asc::after {
      content: '‚Üë';
      opacity: 1;
    }
    
    th.sort-desc::after {
      content: '‚Üì';
      opacity: 1;
    }
    
    /* Checkbox personalizado */
    .checkbox-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .checkbox {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
      cursor: pointer;
    }
    
    tr:hover {
      background: rgba(34, 197, 94, 0.08);
    }
    
    tr.selected {
      background: rgba(34, 197, 94, 0.15);
      border-left: 4px solid var(--accent);
    }
    
    tr.selected td {
      color: var(--text);
    }
    
    /* Status badges mejorados */
    .status-badge {
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      text-align: center;
      min-width: 80px;
      display: inline-block;
    }
    
    .status-103 {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: #451a03;
    }
    
    .status-pending {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: #451a03;
    }
    
    .status-confirmed {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #052e16;
    }
    
    .status-cancelled {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: #450a0a;
    }
    
    .status-new {
      background: linear-gradient(135deg, #a855f7, #9333ea);
      color: #2d1b69;
    }
    
    /* Estilos de asignaci√≥n */
    .team-assignment {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: #451a03;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    
    .assignment-date {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    /* Loading y estados vac√≠os */
    .loading-state,
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #2c4a5e;
      border-top: 4px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .empty-icon {
      font-size: 4rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    /* Responsive mejorado */
    @media (max-width: 768px) {
      .manager-container {
        padding: 16px;
      }
      
      .controls-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .bulk-actions {
        flex-direction: column;
        align-items: stretch;
      }
      
      .bulk-actions button {
        width: 100%;
        margin-bottom: 8px;
      }
      
      th, td {
        padding: 12px 8px;
        font-size: 0.8rem;
      }
      
      .table-header {
        flex-direction: column;
        gap: 16px;
        align-items: stretch;
      }
      
      .sort-controls {
        justify-content: center;
      }
      
      .technicians-grid {
        grid-template-columns: 1fr;
      }
      
      .assignment-actions {
        flex-direction: column;
      }
      
      .team-assignment,
      .assignment-date {
        font-size: 0.7rem;
        padding: 2px 6px;
      }
    }
  </style>
  <script defer src="./js/i18n.js"></script>
  <!-- PapaParse para procesar CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="page with-navbar">
  <nav class="navbar">
    <a href="./index.html" class="navbar-brand">
      üë• Bot de Citas CLARITY
    </a>
    <div class="navbar-nav">
      <a href="./index.html" class="nav-link">Inicio</a>
      <a href="./conversations.html" class="nav-link">Demo</a>
      <a href="./manager.html" class="nav-link active">Gestor</a>
      <a href="./dashboard.html" class="nav-link">Dashboard</a>
      <a href="./settings.html" class="nav-link">Config</a>
    </div>
  </nav>
  <div class="manager-container">
    <div class="manager-header">
      <div class="header-content">
        <div class="header-text">
          <h1 id="managerTitle">Kunden-Manager</h1>
          <p id="managerSubtitle">Laden und verwalten Sie Ihre Kundendatenbank intelligent</p>
        </div>
        <div class="language-selector">
          <button class="lang-btn" data-lang="de">üá©üá™</button>
          <button class="lang-btn" data-lang="es">üá™üá∏</button>
          <button class="lang-btn" data-lang="en">üá∫üá∏</button>
        </div>
      </div>
    </div>
    
    <div class="controls-section">
      <div class="controls-grid">
        <div class="control-group">
          <label>üìÅ Archivo CSV</label>
          <input type="file" id="csvFile" accept=".csv">
        </div>
        <div class="control-group">
          <label>üè¢ Proyecto</label>
          <select id="filterProject"><option value="">-- Todos los proyectos --</option></select>
        </div>
        <div class="control-group">
          <label>üìä Estado</label>
          <select id="filterStatus"><option value="">-- Todos los estados --</option></select>
        </div>
        <div class="control-group">
          <label>üìç Ciudad/C√≥digo Postal</label>
          <select id="filterCity"><option value="">-- Todas las ciudades --</option></select>
        </div>
        <div class="control-group">
          <label>üîç B√∫squeda</label>
          <input type="text" id="searchInput" placeholder="Buscar por nombre, tel√©fono, email...">
        </div>
      </div>
      
      <div class="quick-filters">
        <button class="quick-filter-btn" id="filterAll">üìã Todos</button>
        <button class="quick-filter-btn status-103" id="filter103">üìû Solo Status 103</button>
        <button class="quick-filter-btn" id="filterPending">‚è≥ Pendientes</button>
        <button class="quick-filter-btn" id="filterConfirmed">‚úÖ Confirmados</button>
        <button class="quick-filter-btn" id="clearFilters">üîÑ Limpiar Filtros</button>
      </div>
    </div>
    
    <div class="bulk-actions">
      <button id="selectAllBtn">‚úÖ Seleccionar Todo</button>
      <button id="clearSelectionBtn" disabled>‚ùå Limpiar Selecci√≥n</button>
      <div class="selection-info" id="selectionInfo">0 clientes seleccionados</div>
      <button id="bulkScheduleBtn" class="primary" disabled>üìÖ Agendar Masivo</button>
      <button id="assignTeamBtn" class="team-action" disabled>üë• Asignar a Equipo</button>
      <button id="resourceManagementBtn" class="resource-btn view-details">üìä Gesti√≥n de Recursos</button>
      <button id="syncExternalBtn" class="integration" disabled>üîÑ Sincronizar con Sistema Externo</button>
      <button id="exportSelectedBtn" disabled>üíæ Exportar CSV</button>
      <button id="deleteSelectedBtn" class="danger" disabled>üóëÔ∏è Eliminar Seleccionados</button>
    </div>
    
    <!-- Panel de asignaci√≥n de equipos -->
    <div class="team-assignment-panel" id="teamAssignmentPanel" style="display: none;">
      <div class="panel-header">
        <h3>üë• Asignaci√≥n de Equipos</h3>
        <button class="close-panel" id="closeTeamPanelBtn">‚úñ</button>
      </div>
      <div class="panel-content">
        <div class="assignment-summary">
          <div class="summary-item">
            <span class="summary-label">Clientes seleccionados:</span>
            <span class="summary-value" id="selectedClientsCount">0</span>
          </div>
        </div>
        
        <div class="team-selection">
          <h4>Seleccionar Equipo T√©cnico</h4>
          <div class="team-options">
            <div class="team-option">
              <label for="teamSelect">Equipo:</label>
              <select id="teamSelect">
                <option value="">-- Team ausw√§hlen --</option>
                <option value="team-berlin">Team Berlin - Nord</option>
                <option value="team-munich">Team M√ºnchen - S√ºd</option>
                <option value="team-hamburg">Team Hamburg - West</option>
                <option value="team-cologne">Team K√∂ln - Zentral</option>
                <option value="team-frankfurt">Team Frankfurt - Rhein-Main</option>
                <option value="team-stuttgart">Team Stuttgart - Baden-W√ºrttemberg</option>
              </select>
            </div>
            
            <div class="technicians-list" id="techniciansContainer" style="display: none;">
              <h5>T√©cnicos del Equipo:</h5>
              <div class="technicians-grid" id="techniciansGrid">
                <!-- Se llenar√° din√°micamente -->
              </div>
            </div>
          </div>
        </div>
        
        <div class="assignment-options">
          <h4>Opciones de Asignaci√≥n</h4>
          <label class="checkbox-option">
            <input type="checkbox" id="autoDistribute" checked>
            <span>Distribuir autom√°ticamente entre t√©cnicos del equipo</span>
          </label>
          <label class="checkbox-option">
            <input type="checkbox" id="considerWorkload">
            <span>Considerar carga de trabajo actual de cada t√©cnico</span>
          </label>
          <label class="checkbox-option">
            <input type="checkbox" id="geographicProximity" checked>
            <span>Priorizar proximidad geogr√°fica</span>
          </label>
        </div>
        
        <div class="assignment-preview" id="assignmentPreview" style="display: none;">
          <h4>Vista Previa de Asignaci√≥n</h4>
          <div class="preview-content" id="previewContent">
            <!-- Se mostrar√° la distribuci√≥n propuesta -->
          </div>
        </div>
        
        <div class="assignment-actions">
          <button id="previewAssignmentBtn" class="preview-btn" disabled>üîç Vista Previa</button>
          <button id="confirmAssignmentBtn" class="confirm-btn" disabled>‚úÖ Confirmar Asignaci√≥n</button>
        </div>
      </div>
    </div>
    
    <!-- Panel de gesti√≥n de recursos -->
    <div class="resource-management" id="resourceManagementPanel" style="display: none;">
      <div class="panel-header">
        <h3>üìä Gesti√≥n Avanzada de Recursos</h3>
        <button class="close-panel" id="closeResourcePanelBtn">‚úñ</button>
      </div>
      
      <!-- Filtros de recursos -->
      <div class="resource-filters">
        <div class="filter-group">
          <span class="filter-label">Regi√≥n:</span>
          <select class="filter-select" id="regionFilter">
            <option value="">Todas las regiones</option>
            <option value="Berlin-Brandenburg">Berlin-Brandenburg</option>
            <option value="Bayern">Bayern</option>
            <option value="Norddeutschland">Norddeutschland</option>
            <option value="Nordrhein-Westfalen">Nordrhein-Westfalen</option>
            <option value="Hessen">Hessen</option>
            <option value="Baden-W√ºrttemberg">Baden-W√ºrttemberg</option>
          </select>
        </div>
        <div class="filter-group">
          <span class="filter-label">Eficiencia:</span>
          <select class="filter-select" id="efficiencyFilter">
            <option value="">Todas</option>
            <option value="high">Alta (‚â•95%)</option>
            <option value="medium">Media (85-94%)</option>
            <option value="low">Baja (<85%)</option>
          </select>
        </div>
        <div class="filter-group">
          <span class="filter-label">Carga de Trabajo:</span>
          <select class="filter-select" id="workloadFilter">
            <option value="">Todas</option>
            <option value="low">Baja (‚â§5)</option>
            <option value="medium">Media (6-9)</option>
            <option value="high">Alta (‚â•10)</option>
          </select>
        </div>
        <div class="filter-group">
          <span class="filter-label">Especialidad:</span>
          <select class="filter-select" id="specialtyFilter">
            <option value="">Todas</option>
            <option value="Glasfaser Installation">Glasfaser Installation</option>
            <option value="Netzwerk">Netzwerk Setup/Installation</option>
            <option value="Router">Router Setup/Konfiguration</option>
            <option value="Support">Technical Support/Wartung</option>
          </select>
        </div>
      </div>

      <!-- Vista general de recursos -->
      <div class="resource-overview">
        <div class="resource-card">
          <h4>Total T√©cnicos</h4>
          <div class="resource-value" id="totalTechnicians">16</div>
          <div class="resource-trend trend-neutral">üìä Sin cambios</div>
        </div>
        <div class="resource-card">
          <h4>Eficiencia Promedio</h4>
          <div class="resource-value" id="avgEfficiency">93%</div>
          <div class="resource-trend trend-up">üìà +2.1%</div>
        </div>
        <div class="resource-card">
          <h4>Carga Promedio</h4>
          <div class="resource-value" id="avgWorkload">7.2</div>
          <div class="resource-trend trend-down">üìâ -0.8</div>
        </div>
        <div class="resource-card">
          <h4>Cobertura PLZ</h4>
          <div class="resource-value" id="plzCoverage">48</div>
          <div class="resource-trend trend-up">üìà +3 zonas</div>
        </div>
        <div class="resource-card">
          <h4>Alertas Activas</h4>
          <div class="resource-value" id="activeAlerts">2</div>
          <div class="resource-trend trend-down">üìâ -1 alerta</div>
        </div>
      </div>

      <!-- Grid de equipos -->
      <div class="teams-grid" id="teamsGrid">
        <!-- Se llenar√° din√°micamente -->
      </div>

      <!-- Acciones de recursos -->
      <div class="resource-actions">
        <button class="resource-btn optimize" id="optimizeResourcesBtn">‚ö° Optimizar Distribuci√≥n</button>
        <button class="resource-btn schedule" id="scheduleOptimizationBtn">üìÖ Programar Optimizaci√≥n</button>
        <button class="resource-btn view-details" id="exportResourceReportBtn">üìä Generar Reporte</button>
        <button class="resource-btn view-details" id="alertsManagementBtn">üö® Gestionar Alertas</button>
      </div>
    </div>

    <!-- Panel de integraci√≥n -->
    <div class="integration-panel" id="integrationPanel" style="display: none;">
      <div class="panel-header">
        <h3>üîó Integraci√≥n con Sistema de Citas</h3>
        <button class="close-panel" id="closePanelBtn">‚úñ</button>
      </div>
      <div class="panel-content">
        <div class="integration-status">
          <div class="status-item">
            <span class="status-label">Estado de conexi√≥n:</span>
            <span class="status-value connected" id="connectionStatus">‚úÖ Conectado</span>
          </div>
          <div class="status-item">
            <span class="status-label">√öltima sincronizaci√≥n:</span>
            <span class="status-value" id="lastSync">Hace 2 minutos</span>
          </div>
          <div class="status-item">
            <span class="status-label">Clientes sincronizados:</span>
            <span class="status-value" id="syncedCount">1,247 / 1,250</span>
          </div>
        </div>
        
        <div class="sync-options">
          <h4>Opciones de Sincronizaci√≥n</h4>
          <label class="checkbox-option">
            <input type="checkbox" id="autoSync" checked>
            <span>Sincronizaci√≥n autom√°tica cada 5 minutos</span>
          </label>
          <label class="checkbox-option">
            <input type="checkbox" id="bidirectionalSync" checked>
            <span>Sincronizaci√≥n bidireccional (enviar y recibir cambios)</span>
          </label>
          <label class="checkbox-option">
            <input type="checkbox" id="conflictResolution">
            <span>Resoluci√≥n autom√°tica de conflictos</span>
          </label>
        </div>
        
        <div class="sync-actions">
          <button id="forceSyncBtn" class="sync-btn">üîÑ Forzar Sincronizaci√≥n Completa</button>
          <button id="testConnectionBtn" class="test-btn">üîç Probar Conexi√≥n</button>
        </div>
      </div>
    </div>
    
    <div class="table-section">
      <div class="table-header">
        <div class="table-title" id="tableTitle">üìã Base de Datos de Clientes</div>
        <div class="sort-controls">
          <label>üìà Ordenar por:</label>
          <select id="sortSelect">
            <option value="">-- Sin ordenar --</option>
            <option value="name-asc">Nombre A-Z</option>
            <option value="name-desc">Nombre Z-A</option>
            <option value="status-asc">Estado A-Z</option>
            <option value="status-desc">Estado Z-A</option>
            <option value="city-asc">Ciudad A-Z</option>
            <option value="city-desc">Ciudad Z-A</option>
          </select>
        </div>
      </div>
      <div class="table-container">
        <div id="loadingState" class="loading-state" style="display: none;">
          <div class="loading-spinner"></div>
          <div>Cargando datos...</div>
        </div>
        <div id="emptyState" class="empty-state" style="display: none;">
          <div class="empty-icon">üìÑ</div>
          <div>No hay datos para mostrar</div>
          <p>Selecciona un archivo CSV para comenzar</p>
        </div>
        <table id="dataTable" style="display: none;">
          <thead><tr id="tableHead"></tr></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    (function(){
      // Referencias a elementos del DOM
      const csvFile = document.getElementById('csvFile');
      const filterProject = document.getElementById('filterProject');
      const filterStatus = document.getElementById('filterStatus');
      const filterCity = document.getElementById('filterCity');
      const searchInput = document.getElementById('searchInput');
      const sortSelect = document.getElementById('sortSelect');
      
      const tableHead = document.getElementById('tableHead');
      const tableBody = document.getElementById('tableBody');
      const dataTable = document.getElementById('dataTable');
      const loadingState = document.getElementById('loadingState');
      const emptyState = document.getElementById('emptyState');
      const tableTitle = document.getElementById('tableTitle');
      
      // Botones de acci√≥n
      const selectAllBtn = document.getElementById('selectAllBtn');
      const clearSelectionBtn = document.getElementById('clearSelectionBtn');
      const bulkScheduleBtn = document.getElementById('bulkScheduleBtn');
      const exportSelectedBtn = document.getElementById('exportSelectedBtn');
      const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
      
      // Filtros r√°pidos
      const filterAll = document.getElementById('filterAll');
      const filter103 = document.getElementById('filter103');
      const filterPending = document.getElementById('filterPending');
      const filterConfirmed = document.getElementById('filterConfirmed');
      const clearFilters = document.getElementById('clearFilters');
      
      const selectionInfo = document.getElementById('selectionInfo');
      
      // Estado de la aplicaci√≥n
      let rawData = [];
      let displayedData = [];
      let selectedRows = new Set();
      let headers = [];
      let currentSort = { column: null, direction: 'asc' };
      let currentQuickFilter = 'all';

      // Helper: detectar nombre de columna ignorando may√∫sculas/min√∫sculas
      function getColumnName(possibleNames, headers) {
        const lower = headers.map(h => h.toLowerCase());
        for (const name of possibleNames) {
          const idx = lower.indexOf(name.toLowerCase());
          if (idx !== -1) return headers[idx];
        }
        return null;
      }
      
      // Mostrar estado de carga
      function showLoading() {
        loadingState.style.display = 'block';
        emptyState.style.display = 'none';
        dataTable.style.display = 'none';
      }
      
      // Mostrar estado vac√≠o
      function showEmpty() {
        loadingState.style.display = 'none';
        emptyState.style.display = 'block';
        dataTable.style.display = 'none';
      }
      
      // Mostrar tabla
      function showTable() {
        loadingState.style.display = 'none';
        emptyState.style.display = 'none';
        dataTable.style.display = 'table';
      }
      
      // Obtener el estado de un cliente
      function getStatusClass(status) {
        if (!status) return 'status-new';
        const statusLower = status.toString().toLowerCase();
        if (statusLower === '103') return 'status-103';
        if (statusLower.includes('pendiente') || statusLower.includes('pending')) return 'status-pending';
        if (statusLower.includes('confirmado') || statusLower.includes('confirmed')) return 'status-confirmed';
        if (statusLower.includes('cancelado') || statusLower.includes('cancelled')) return 'status-cancelled';
        return 'status-new';
      }
      
      // Formatear valor de celda
      function formatCellValue(key, value, row) {
        if (!value && !key.startsWith('_assigned')) return '';
        
        const keyLower = key.toLowerCase();
        
        // Mostrar asignaci√≥n de equipo
        if (key === '_assignedTeam' && value) {
          return `<span class="team-assignment">üë• ${value}</span>`;
        }
        
        if (key === '_assignedDate' && value) {
          return `<span class="assignment-date">üìÖ ${value}</span>`;
        }
        
        // Formatear estado como badge
        if (keyLower.includes('estado') || keyLower.includes('status')) {
          return `<span class="status-badge ${getStatusClass(value)}">${value}</span>`;
        }
        
        // Formatear tel√©fono
        if (keyLower.includes('tel') || keyLower.includes('phone')) {
          return `<a href="tel:${value}" class="link">${value}</a>`;
        }
        
        // Formatear email
        if (keyLower.includes('email') || keyLower.includes('correo')) {
          return `<a href="mailto:${value}" class="link">${value}</a>`;
        }
        
        return value ? value.toString() : '';
      }
      
      // Renderizar tabla
      function renderTable(data) {
        if (!data || data.length === 0) {
          showEmpty();
          return;
        }
        
        showTable();
        tableBody.innerHTML = '';
        
        data.forEach((row, idx) => {
          const tr = document.createElement('tr');
          tr.dataset.index = idx;
          
          // Checkbox para selecci√≥n
          const checkboxTd = document.createElement('td');
          checkboxTd.innerHTML = `
            <div class="checkbox-wrapper">
              <input type="checkbox" class="checkbox row-checkbox" data-index="${idx}" ${selectedRows.has(idx) ? 'checked' : ''}>
            </div>
          `;
          tr.appendChild(checkboxTd);
          
          // Datos de la fila original
          headers.forEach(header => {
            const td = document.createElement('td');
            const value = row[header] || '';
            td.innerHTML = formatCellValue(header, value, row);
            tr.appendChild(td);
          });
          
          // Columnas de asignaci√≥n
          const teamTd = document.createElement('td');
          teamTd.innerHTML = formatCellValue('_assignedTeam', row._assignedTeam, row);
          tr.appendChild(teamTd);
          
          const dateTd = document.createElement('td');
          dateTd.innerHTML = formatCellValue('_assignedDate', row._assignedDate, row);
          tr.appendChild(dateTd);
          
          // Marcar fila como seleccionada si est√° en el set
          if (selectedRows.has(idx)) {
            tr.classList.add('selected');
          }
          
          tableBody.appendChild(tr);
        });
        
        updateTableTitle();
        updateSelectionUI();
      }
      
      // Actualizar t√≠tulo de la tabla
      function updateTableTitle() {
        const total = rawData.length;
        const showing = displayedData.length;
        const selected = selectedRows.size;
        
        let title = `üìã Base de Datos de Clientes`;
        if (total > 0) {
          title += ` (${showing}/${total})`;
        }
        tableTitle.textContent = title;
      }
      
      // Actualizar UI de selecci√≥n
      function updateSelectionUI() {
        const selectedCount = selectedRows.size;
        selectionInfo.textContent = `${selectedCount} cliente${selectedCount !== 1 ? 's' : ''} seleccionado${selectedCount !== 1 ? 's' : ''}`;
        
        // Habilitar/deshabilitar botones
        clearSelectionBtn.disabled = selectedCount === 0;
        bulkScheduleBtn.disabled = selectedCount === 0;
        document.getElementById('syncExternalBtn').disabled = selectedCount === 0;
        document.getElementById('assignTeamBtn').disabled = selectedCount === 0;
        exportSelectedBtn.disabled = selectedCount === 0;
        deleteSelectedBtn.disabled = selectedCount === 0;
        
        // Actualizar bot√≥n de seleccionar todo
        const totalShowing = displayedData.length;
        if (selectedCount === 0) {
          selectAllBtn.textContent = '‚úÖ Seleccionar Todo';
        } else if (selectedCount === totalShowing) {
          selectAllBtn.textContent = '‚ùå Deseleccionar Todo';
        } else {
          selectAllBtn.textContent = `‚úÖ Seleccionar Todo (${totalShowing})`;
        }
      }
      
      // Configurar encabezados de tabla
      function setupTableHeaders() {
        tableHead.innerHTML = '';
        
        // Checkbox header
        const checkboxTh = document.createElement('th');
        checkboxTh.innerHTML = `
          <div class="checkbox-wrapper">
            <input type="checkbox" class="checkbox" id="selectAllCheckbox">
          </div>
        `;
        tableHead.appendChild(checkboxTh);
        
        // Headers de datos originales
        headers.forEach(header => {
          const th = document.createElement('th');
          th.textContent = header;
          th.classList.add('sortable');
          th.dataset.column = header;
          tableHead.appendChild(th);
        });
        
        // Headers de asignaci√≥n
        const teamTh = document.createElement('th');
        teamTh.textContent = 'Equipo Asignado';
        teamTh.classList.add('sortable');
        teamTh.dataset.column = '_assignedTeam';
        tableHead.appendChild(teamTh);
        
        const dateTh = document.createElement('th');
        dateTh.textContent = 'Fecha Asignaci√≥n';
        dateTh.classList.add('sortable');
        dateTh.dataset.column = '_assignedDate';
        tableHead.appendChild(dateTh);
        
        // Event listener para checkbox principal
        document.getElementById('selectAllCheckbox').addEventListener('change', function() {
          const checked = this.checked;
          selectedRows.clear();
          
          if (checked) {
            displayedData.forEach((_, idx) => selectedRows.add(idx));
          }
          
          renderTable(displayedData);
        });
        
        // Event listeners para ordenamiento
        tableHead.querySelectorAll('th.sortable').forEach(th => {
          th.addEventListener('click', () => {
            sortBy(th.dataset.column);
          });
        });
      }
      
      // Ordenar datos
      function sortBy(column) {
        if (currentSort.column === column) {
          currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
          currentSort.column = column;
          currentSort.direction = 'asc';
        }
        
        displayedData.sort((a, b) => {
          const aVal = (a[column] || '').toString().toLowerCase();
          const bVal = (b[column] || '').toString().toLowerCase();
          
          let comparison = aVal.localeCompare(bVal);
          return currentSort.direction === 'desc' ? -comparison : comparison;
        });
        
        updateSortUI();
        renderTable(displayedData);
      }
      
      // Actualizar UI de ordenamiento
      function updateSortUI() {
        tableHead.querySelectorAll('th').forEach(th => {
          th.classList.remove('sort-asc', 'sort-desc');
        });
        
        if (currentSort.column) {
          const th = tableHead.querySelector(`th[data-column="${currentSort.column}"]`);
          if (th) {
            th.classList.add(`sort-${currentSort.direction}`);
          }
        }
      }
      
      // Actualizar filtros
      function updateFilters(headers, data) {
        const projectCol = getColumnName(['proyecto','project'], headers);
        const statusCol = getColumnName(['estado','status'], headers);
        const cityCol = getColumnName(['ciudad','city','plz','codigo postal','zip'], headers);
        
        function fillSelect(select, values, placeholder) {
          select.innerHTML = `<option value="">${placeholder}</option>`;
          [...new Set(values.filter(v => v))].sort().forEach(val => {
            const opt = document.createElement('option');
            opt.value = val;
            opt.textContent = val;
            select.appendChild(opt);
          });
        }
        
        fillSelect(filterProject, data.map(row => row[projectCol] || ''), '-- Todos los proyectos --');
        fillSelect(filterStatus, data.map(row => row[statusCol] || ''), '-- Todos los estados --');
        fillSelect(filterCity, data.map(row => row[cityCol] || ''), '-- Todas las ciudades --');
        
        // Actualizar opciones de ordenamiento
        sortSelect.innerHTML = '<option value="">-- Sin ordenar --</option>';
        headers.forEach(header => {
          sortSelect.innerHTML += `
            <option value="${header}-asc">${header} A-Z</option>
            <option value="${header}-desc">${header} Z-A</option>
          `;
        });
      }
      
      // Aplicar filtros
      function applyFilters() {
        displayedData = rawData.filter(row => {
          const projectVal = filterProject.value;
          const statusVal = filterStatus.value;
          const cityVal = filterCity.value;
          const searchVal = searchInput.value.toLowerCase();
          
          const projectCol = getColumnName(['proyecto','project'], headers);
          const statusCol = getColumnName(['estado','status'], headers);
          const cityCol = getColumnName(['ciudad','city','plz','codigo postal','zip'], headers);
          const nameCol = getColumnName(['nombre','name','cliente','cliente_nombre'], headers);
          const phoneCol = getColumnName(['telefono','phone','tel'], headers);
          const emailCol = getColumnName(['email','correo'], headers);
          
          // Filtros de selecci√≥n
          const hasProject = !projectVal || (row[projectCol] || '') === projectVal;
          const hasStatus = !statusVal || (row[statusCol] || '') === statusVal;
          const hasCity = !cityVal || (row[cityCol] || '') === cityVal;
          
          // Filtros r√°pidos
          let quickFilterMatch = true;
          if (currentQuickFilter === '103') {
            quickFilterMatch = (row[statusCol] || '').toString() === '103';
          } else if (currentQuickFilter === 'pending') {
            const status = (row[statusCol] || '').toString().toLowerCase();
            quickFilterMatch = status.includes('pendiente') || status.includes('pending');
          } else if (currentQuickFilter === 'confirmed') {
            const status = (row[statusCol] || '').toString().toLowerCase();
            quickFilterMatch = status.includes('confirmado') || status.includes('confirmed');
          }
          
          // B√∫squeda de texto
          let searchMatch = true;
          if (searchVal) {
            const searchFields = [
              row[nameCol] || '',
              row[phoneCol] || '',
              row[emailCol] || ''
            ].join(' ').toLowerCase();
            searchMatch = searchFields.includes(searchVal);
          }
          
          return hasProject && hasStatus && hasCity && quickFilterMatch && searchMatch;
        });
        
        // Limpiar selecci√≥n de filas que ya no est√°n visibles
        selectedRows = new Set([...selectedRows].filter(idx => 
          displayedData.some((_, i) => i === idx)
        ));
        
        renderTable(displayedData);
      }
      
      // Event listeners para filtros
      [filterProject, filterStatus, filterCity].forEach(select => {
        select.addEventListener('change', applyFilters);
      });
      
      searchInput.addEventListener('input', debounce(applyFilters, 300));
      
      sortSelect.addEventListener('change', function() {
        if (!this.value) {
          currentSort = { column: null, direction: 'asc' };
          displayedData = [...rawData];
          applyFilters();
          return;
        }
        
        const [column, direction] = this.value.split('-');
        currentSort = { column, direction };
        sortBy(column);
      });
      
      // Filtros r√°pidos
      filterAll.addEventListener('click', function() {
        currentQuickFilter = 'all';
        updateQuickFilterUI(this);
        applyFilters();
      });
      
      filter103.addEventListener('click', function() {
        currentQuickFilter = '103';
        updateQuickFilterUI(this);
        applyFilters();
      });
      
      filterPending.addEventListener('click', function() {
        currentQuickFilter = 'pending';
        updateQuickFilterUI(this);
        applyFilters();
      });
      
      filterConfirmed.addEventListener('click', function() {
        currentQuickFilter = 'confirmed';
        updateQuickFilterUI(this);
        applyFilters();
      });
      
      clearFilters.addEventListener('click', function() {
        filterProject.value = '';
        filterStatus.value = '';
        filterCity.value = '';
        searchInput.value = '';
        sortSelect.value = '';
        currentQuickFilter = 'all';
        currentSort = { column: null, direction: 'asc' };
        updateQuickFilterUI(filterAll);
        displayedData = [...rawData];
        applyFilters();
      });
      
      // Actualizar UI de filtros r√°pidos
      function updateQuickFilterUI(activeBtn) {
        document.querySelectorAll('.quick-filter-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        activeBtn.classList.add('active');
      }
      
      // Debounce para b√∫squeda
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }
      
      // Manejo de selecci√≥n
      selectAllBtn.addEventListener('click', function() {
        const totalShowing = displayedData.length;
        const selectedCount = selectedRows.size;
        
        if (selectedCount === totalShowing) {
          // Deseleccionar todo
          selectedRows.clear();
        } else {
          // Seleccionar todo lo visible
          selectedRows.clear();
          displayedData.forEach((_, idx) => selectedRows.add(idx));
        }
        
        renderTable(displayedData);
      });
      
      clearSelectionBtn.addEventListener('click', function() {
        selectedRows.clear();
        renderTable(displayedData);
      });
      
      // Event delegation para checkboxes de filas
      tableBody.addEventListener('change', function(e) {
        if (e.target.classList.contains('row-checkbox')) {
          const idx = parseInt(e.target.dataset.index);
          
          if (e.target.checked) {
            selectedRows.add(idx);
          } else {
            selectedRows.delete(idx);
          }
          
          e.target.closest('tr').classList.toggle('selected', e.target.checked);
          updateSelectionUI();
        }
      });
      
      // Gesti√≥n expandida de recursos
      const resourceManagementBtn = document.getElementById('resourceManagementBtn');
      const resourceManagementPanel = document.getElementById('resourceManagementPanel');
      const closeResourcePanelBtn = document.getElementById('closeResourcePanelBtn');
      const teamsGrid = document.getElementById('teamsGrid');
      
      // Gesti√≥n de equipos
      const assignTeamBtn = document.getElementById('assignTeamBtn');
      const teamAssignmentPanel = document.getElementById('teamAssignmentPanel');
      const closeTeamPanelBtn = document.getElementById('closeTeamPanelBtn');
      const teamSelect = document.getElementById('teamSelect');
      const techniciansContainer = document.getElementById('techniciansContainer');
      const techniciansGrid = document.getElementById('techniciansGrid');
      const previewAssignmentBtn = document.getElementById('previewAssignmentBtn');
      const confirmAssignmentBtn = document.getElementById('confirmAssignmentBtn');
      const assignmentPreview = document.getElementById('assignmentPreview');
      const previewContent = document.getElementById('previewContent');
      const selectedClientsCount = document.getElementById('selectedClientsCount');
      
      // Deutsche Teams und Techniker
      const teamsData = {
        'team-berlin': {
          name: 'Team Berlin - Nord',
          region: 'Berlin-Brandenburg',
          technicians: [
            { id: 'tech-01', name: 'Klaus M√ºller', specialty: 'Glasfaser Installation', workload: 8, zone: 'Berlin-Mitte', efficiency: 94, plz: ['10115', '10117', '10119'] },
            { id: 'tech-02', name: 'Petra Schmidt', specialty: 'Netzwerk Setup', workload: 5, zone: 'Berlin-Nord', efficiency: 97, plz: ['13347', '13349', '13351'] },
            { id: 'tech-03', name: 'Hans Weber', specialty: 'Wartung & Support', workload: 12, zone: 'Potsdam', efficiency: 89, plz: ['14467', '14469', '14471'] }
          ]
        },
        'team-munich': {
          name: 'Team M√ºnchen - S√ºd',
          region: 'Bayern',
          technicians: [
            { id: 'tech-04', name: 'Andreas Fischer', specialty: 'Glasfaser Installation', workload: 6, zone: 'M√ºnchen-Stadt', efficiency: 92, plz: ['80331', '80333', '80335'] },
            { id: 'tech-05', name: 'Sabine Wagner', specialty: 'Router Konfiguration', workload: 9, zone: 'M√ºnchen-S√ºd', efficiency: 95, plz: ['81669', '81671', '81673'] },
            { id: 'tech-06', name: 'Michael Bauer', specialty: 'Technischer Support', workload: 4, zone: 'Augsburg', efficiency: 91, plz: ['86150', '86152', '86154'] }
          ]
        },
        'team-hamburg': {
          name: 'Team Hamburg - West',
          region: 'Norddeutschland',
          technicians: [
            { id: 'tech-07', name: 'J√ºrgen Koch', specialty: 'Glasfaser Installation', workload: 7, zone: 'Hamburg-Altona', efficiency: 96, plz: ['22765', '22767', '22769'] },
            { id: 'tech-08', name: 'Ute Richter', specialty: 'Netzwerk Installation', workload: 10, zone: 'Hamburg-Eimsb√ºttel', efficiency: 88, plz: ['20144', '20146', '20148'] },
            { id: 'tech-09', name: 'Thomas Klein', specialty: 'System Administration', workload: 3, zone: 'Bremen', efficiency: 93, plz: ['28195', '28197', '28199'] }
          ]
        },
        'team-cologne': {
          name: 'Team K√∂ln - Zentral',
          region: 'Nordrhein-Westfalen', 
          technicians: [
            { id: 'tech-10', name: 'Brigitte Hoffmann', specialty: 'Glasfaser Installation', workload: 11, zone: 'K√∂ln-Innenstadt', efficiency: 90, plz: ['50667', '50668', '50670'] },
            { id: 'tech-11', name: 'Stefan Sch√§fer', specialty: 'Hardware Installation', workload: 2, zone: 'D√ºsseldorf', efficiency: 98, plz: ['40210', '40212', '40213'] }
          ]
        },
        'team-frankfurt': {
          name: 'Team Frankfurt - Rhein-Main',
          region: 'Hessen',
          technicians: [
            { id: 'tech-12', name: 'Ingrid Zimmermann', specialty: 'Glasfaser Installation', workload: 8, zone: 'Frankfurt-Zentrum', efficiency: 94, plz: ['60311', '60313', '60316'] },
            { id: 'tech-13', name: 'Wolfgang Braun', specialty: 'Router Setup', workload: 6, zone: 'Wiesbaden', efficiency: 92, plz: ['65183', '65185', '65187'] },
            { id: 'tech-14', name: 'Monika Hartmann', specialty: 'Kundensupport', workload: 4, zone: 'Darmstadt', efficiency: 96, plz: ['64283', '64285', '64287'] }
          ]
        },
        'team-stuttgart': {
          name: 'Team Stuttgart - Baden-W√ºrttemberg',
          region: 'Baden-W√ºrttemberg',
          technicians: [
            { id: 'tech-15', name: 'Ralf Schneider', specialty: 'Glasfaser Installation', workload: 9, zone: 'Stuttgart-Mitte', efficiency: 91, plz: ['70173', '70174', '70176'] },
            { id: 'tech-16', name: 'Gisela Lehmann', specialty: 'Netzwerk Optimierung', workload: 7, zone: 'Karlsruhe', efficiency: 95, plz: ['76131', '76133', '76135'] }
          ]
        }
      };
      
      // Funciones para gesti√≥n expandida de recursos
      function calculateResourceMetrics() {
        const allTechnicians = Object.values(teamsData).flatMap(team => team.technicians);
        const totalTechnicians = allTechnicians.length;
        const avgEfficiency = Math.round(allTechnicians.reduce((sum, tech) => sum + tech.efficiency, 0) / totalTechnicians);
        const avgWorkload = Math.round((allTechnicians.reduce((sum, tech) => sum + tech.workload, 0) / totalTechnicians) * 10) / 10;
        const totalPLZ = new Set(allTechnicians.flatMap(tech => tech.plz)).size;
        const highWorkloadTechs = allTechnicians.filter(tech => tech.workload >= 10).length;
        const lowEfficiencyTechs = allTechnicians.filter(tech => tech.efficiency < 90).length;
        
        return {
          totalTechnicians,
          avgEfficiency,
          avgWorkload,
          totalPLZ,
          activeAlerts: highWorkloadTechs + lowEfficiencyTechs
        };
      }
      
      function getEfficiencyClass(efficiency) {
        if (efficiency >= 95) return 'efficiency-high';
        if (efficiency >= 85) return 'efficiency-medium';
        return 'efficiency-low';
      }
      
      function getWorkloadClass(workload) {
        if (workload >= 10) return 'workload-high';
        if (workload >= 6) return 'workload-medium';
        return 'workload-low';
      }
      
      function getWorkloadFillWidth(workload) {
        return Math.min((workload / 15) * 100, 100); // Max 15 appointments
      }
      
      function getWorkloadFillColor(workload) {
        if (workload >= 10) return '#ef4444';
        if (workload >= 6) return '#f59e0b';
        return '#22c55e';
      }
      
      function getPerformanceClass(efficiency) {
        if (efficiency >= 95) return 'performance-excellent';
        if (efficiency >= 90) return 'performance-good';
        if (efficiency >= 85) return 'performance-average';
        return 'performance-poor';
      }
      
      function getPerformanceLabel(efficiency) {
        if (efficiency >= 95) return 'Excelente';
        if (efficiency >= 90) return 'Buena';
        if (efficiency >= 85) return 'Media';
        return 'Baja';
      }
      
      function renderResourceOverview() {
        const metrics = calculateResourceMetrics();
        document.getElementById('totalTechnicians').textContent = metrics.totalTechnicians;
        document.getElementById('avgEfficiency').textContent = metrics.avgEfficiency + '%';
        document.getElementById('avgWorkload').textContent = metrics.avgWorkload;
        document.getElementById('plzCoverage').textContent = metrics.totalPLZ;
        document.getElementById('activeAlerts').textContent = metrics.activeAlerts;
      }
      
      function renderTeamsGrid(filteredTeams = null) {
        const teams = filteredTeams || teamsData;
        teamsGrid.innerHTML = '';
        
        Object.keys(teams).forEach(teamId => {
          const team = teams[teamId];
          const teamEfficiency = Math.round(team.technicians.reduce((sum, tech) => sum + tech.efficiency, 0) / team.technicians.length);
          const teamWorkload = team.technicians.reduce((sum, tech) => sum + tech.workload, 0);
          const overloadedTechs = team.technicians.filter(tech => tech.workload >= 10).length;
          const lowEfficiencyTechs = team.technicians.filter(tech => tech.efficiency < 90).length;
          const hasAlerts = overloadedTechs > 0 || lowEfficiencyTechs > 0;
          
          const teamCard = document.createElement('div');
          teamCard.className = 'team-card';
          teamCard.innerHTML = `
            <div class="team-header" style="position: relative;">
              ${hasAlerts ? `<div class="alert-badge">${overloadedTechs + lowEfficiencyTechs}</div>` : ''}
              <h3 class="team-name">${team.name}</h3>
              <p class="team-region">${team.region}</p>
            </div>
            
            <div class="team-stats">
              <div class="stat-item">
                <div class="stat-label">T√©cnicos</div>
                <div class="stat-value">${team.technicians.length}</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">Eficiencia</div>
                <div class="stat-value ${getEfficiencyClass(teamEfficiency)}">${teamEfficiency}%</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">Carga Total</div>
                <div class="stat-value ${getWorkloadClass(teamWorkload / team.technicians.length)}">${teamWorkload}</div>
              </div>
            </div>
            
            <div class="technicians-list-expanded">
              ${team.technicians.map(tech => `
                <div class="technician-row">
                  <div class="tech-avatar">${tech.name.split(' ').map(n => n[0]).join('')}</div>
                  <div class="tech-info">
                    <div class="tech-name">${tech.name}</div>
                    <div class="tech-specialty">${tech.specialty} ‚Ä¢ ${tech.zone}</div>
                  </div>
                  <div class="tech-metrics">
                    <div class="metric-badge">
                      <div class="metric-label">Carga</div>
                      <div class="metric-value ${getWorkloadClass(tech.workload)}">${tech.workload}</div>
                      <div class="workload-bar">
                        <div class="workload-fill" style="width: ${getWorkloadFillWidth(tech.workload)}%; background: ${getWorkloadFillColor(tech.workload)};"></div>
                      </div>
                    </div>
                    <div class="metric-badge">
                      <div class="metric-label">Eficiencia</div>
                      <div class="efficiency-circle ${getEfficiencyClass(tech.efficiency)}" style="border-color: ${tech.efficiency >= 95 ? '#22c55e' : tech.efficiency >= 90 ? '#f59e0b' : '#ef4444'};">
                        ${tech.efficiency}%
                      </div>
                    </div>
                    <div class="metric-badge">
                      <div class="metric-label">Rendimiento</div>
                      <div class="performance-indicator ${getPerformanceClass(tech.efficiency)}">
                        ${getPerformanceLabel(tech.efficiency)}
                      </div>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
            
            <div class="resource-actions">
              <button class="resource-btn view-details" onclick="viewTechnicianDetails('${teamId}')">
                üëÅÔ∏è Ver Detalles
              </button>
              <button class="resource-btn optimize" onclick="optimizeTeam('${teamId}')">
                ‚ö° Optimizar
              </button>
              <button class="resource-btn schedule" onclick="scheduleTeam('${teamId}')">
                üìÖ Programar
              </button>
            </div>
          `;
          
          teamsGrid.appendChild(teamCard);
        });
      }
      
      function applyResourceFilters() {
        const regionFilter = document.getElementById('regionFilter').value;
        const efficiencyFilter = document.getElementById('efficiencyFilter').value;
        const workloadFilter = document.getElementById('workloadFilter').value;
        const specialtyFilter = document.getElementById('specialtyFilter').value;
        
        let filteredTeams = {};
        
        Object.keys(teamsData).forEach(teamId => {
          const team = teamsData[teamId];
          
          // Filtro por regi√≥n
          if (regionFilter && team.region !== regionFilter) return;
          
          // Filtrar t√©cnicos dentro del equipo
          let filteredTechnicians = team.technicians.filter(tech => {
            // Filtro por eficiencia
            if (efficiencyFilter === 'high' && tech.efficiency < 95) return false;
            if (efficiencyFilter === 'medium' && (tech.efficiency < 85 || tech.efficiency >= 95)) return false;
            if (efficiencyFilter === 'low' && tech.efficiency >= 85) return false;
            
            // Filtro por carga de trabajo
            if (workloadFilter === 'low' && tech.workload > 5) return false;
            if (workloadFilter === 'medium' && (tech.workload < 6 || tech.workload > 9)) return false;
            if (workloadFilter === 'high' && tech.workload < 10) return false;
            
            // Filtro por especialidad
            if (specialtyFilter) {
              if (specialtyFilter === 'Netzwerk' && !tech.specialty.includes('Netzwerk')) return false;
              if (specialtyFilter === 'Router' && !tech.specialty.includes('Router')) return false;
              if (specialtyFilter === 'Support' && !(tech.specialty.includes('Support') || tech.specialty.includes('Wartung'))) return false;
              if (specialtyFilter === 'Glasfaser Installation' && !tech.specialty.includes('Glasfaser')) return false;
            }
            
            return true;
          });
          
          // Solo incluir el equipo si tiene t√©cnicos que cumplen los filtros
          if (filteredTechnicians.length > 0) {
            filteredTeams[teamId] = {
              ...team,
              technicians: filteredTechnicians
            };
          }
        });
        
        renderTeamsGrid(filteredTeams);
      }
      
      // Event listeners para gesti√≥n de recursos
      resourceManagementBtn.addEventListener('click', function() {
        resourceManagementPanel.style.display = 'block';
        renderResourceOverview();
        renderTeamsGrid();
      });
      
      closeResourcePanelBtn.addEventListener('click', function() {
        resourceManagementPanel.style.display = 'none';
      });
      
      // Event listeners para filtros de recursos
      ['regionFilter', 'efficiencyFilter', 'workloadFilter', 'specialtyFilter'].forEach(filterId => {
        document.getElementById(filterId).addEventListener('change', applyResourceFilters);
      });
      
      // Funciones para acciones de recursos
      window.viewTechnicianDetails = function(teamId) {
        const team = teamsData[teamId];
        alert(`Detalles del equipo ${team.name}:\n\nRegi√≥n: ${team.region}\nT√©cnicos: ${team.technicians.length}\n\nEsta funcionalidad se expandir√° pr√≥ximamente con vista detallada de performance, historial de asignaciones y m√©tricas avanzadas.`);
      };
      
      window.optimizeTeam = function(teamId) {
        const team = teamsData[teamId];
        alert(`Optimizando distribuci√≥n para ${team.name}...\n\nAnalizando carga de trabajo actual y rebalanceando asignaciones autom√°ticamente.\n\nOptimizaci√≥n completada - se redistribuyeron 3 clientes para mejorar eficiencia.`);
        
        // Simular optimizaci√≥n actualizando cargas de trabajo
        team.technicians.forEach(tech => {
          tech.workload = Math.max(1, tech.workload + Math.floor(Math.random() * 3) - 1);
        });
        
        renderTeamsGrid();
        renderResourceOverview();
      };
      
      window.scheduleTeam = function(teamId) {
        const team = teamsData[teamId];
        alert(`Programando optimizaci√≥n autom√°tica para ${team.name}.\n\nLa optimizaci√≥n se ejecutar√° diariamente a las 08:00 y redistributar√° autom√°ticamente la carga de trabajo seg√∫n disponibilidad y eficiencia.`);
      };
      
      // Event listeners para acciones globales de recursos
      document.getElementById('optimizeResourcesBtn').addEventListener('click', function() {
        this.innerHTML = '‚ö° Optimizando...';
        this.disabled = true;
        
        setTimeout(() => {
          // Simular optimizaci√≥n global
          Object.values(teamsData).forEach(team => {
            team.technicians.forEach(tech => {
              tech.workload = Math.max(1, Math.min(12, tech.workload + Math.floor(Math.random() * 3) - 1));
              tech.efficiency = Math.min(100, Math.max(85, tech.efficiency + Math.floor(Math.random() * 3) - 1));
            });
          });
          
          renderTeamsGrid();
          renderResourceOverview();
          
          this.innerHTML = '‚úÖ Optimizaci√≥n Completa';
          setTimeout(() => {
            this.innerHTML = '‚ö° Optimizar Distribuci√≥n';
            this.disabled = false;
          }, 2000);
        }, 3000);
      });
      
      document.getElementById('scheduleOptimizationBtn').addEventListener('click', function() {
        alert('Programaci√≥n de optimizaci√≥n configurada:\n\n‚Ä¢ Optimizaci√≥n diaria: 08:00 CET\n‚Ä¢ Rebalanceo autom√°tico cuando carga > 10\n‚Ä¢ Alertas por eficiencia < 85%\n‚Ä¢ Redistribuci√≥n geogr√°fica semanal\n\nLa siguiente optimizaci√≥n est√° programada para ma√±ana a las 08:00.');
      });
      
      document.getElementById('exportResourceReportBtn').addEventListener('click', function() {
        const metrics = calculateResourceMetrics();
        const reportData = {
          timestamp: new Date().toISOString(),
          summary: metrics,
          teams: Object.keys(teamsData).map(teamId => {
            const team = teamsData[teamId];
            return {
              id: teamId,
              name: team.name,
              region: team.region,
              technicians: team.technicians.length,
              avgEfficiency: Math.round(team.technicians.reduce((sum, tech) => sum + tech.efficiency, 0) / team.technicians.length),
              totalWorkload: team.technicians.reduce((sum, tech) => sum + tech.workload, 0),
              technicians_detail: team.technicians
            };
          })
        };
        
        const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `resource_report_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);
      });
      
      document.getElementById('alertsManagementBtn').addEventListener('click', function() {
        const metrics = calculateResourceMetrics();
        alert(`Gesti√≥n de Alertas Activas (${metrics.activeAlerts}):\n\n‚Ä¢ 1 t√©cnico con sobrecarga (>10 citas)\n‚Ä¢ 1 t√©cnico con baja eficiencia (<90%)\n\nAcciones recomendadas:\n- Redistribuir 3 citas del t√©cnico sobrecargado\n- Programar entrenamiento de eficiencia\n- Revisar asignaci√≥n geogr√°fica\n\nEsta funcionalidad se expandir√° pr√≥ximamente con gesti√≥n avanzada de alertas y notificaciones autom√°ticas.`);
      });
      
      assignTeamBtn.addEventListener('click', function() {
        selectedClientsCount.textContent = selectedRows.size;
        teamAssignmentPanel.style.display = 'block';
        resetTeamAssignment();
      });
      
      closeTeamPanelBtn.addEventListener('click', function() {
        teamAssignmentPanel.style.display = 'none';
        resetTeamAssignment();
      });
      
      teamSelect.addEventListener('change', function() {
        const selectedTeam = this.value;
        
        if (selectedTeam && teamsData[selectedTeam]) {
          showTechnicians(selectedTeam);
          previewAssignmentBtn.disabled = false;
        } else {
          hideTechnicians();
          previewAssignmentBtn.disabled = true;
          confirmAssignmentBtn.disabled = true;
          assignmentPreview.style.display = 'none';
        }
      });
      
      previewAssignmentBtn.addEventListener('click', function() {
        generateAssignmentPreview();
      });
      
      confirmAssignmentBtn.addEventListener('click', function() {
        confirmTeamAssignment();
      });
      
      function showTechnicians(teamId) {
        const team = teamsData[teamId];
        techniciansGrid.innerHTML = '';
        
        team.technicians.forEach(tech => {
          const techCard = document.createElement('div');
          techCard.className = 'technician-card';
          techCard.innerHTML = `
            <div class="technician-name">${tech.name}</div>
            <div class="technician-info">${tech.specialty} - ${tech.zone}</div>
            <div class="technician-workload">Aktuelle Termine: ${tech.workload}</div>
            <div class="technician-efficiency">Effizienz: ${tech.efficiency}%</div>
            <div class="technician-plz">PLZ: ${tech.plz.join(', ')}</div>
          `;
          techniciansGrid.appendChild(techCard);
        });
        
        techniciansContainer.style.display = 'block';
      }
      
      function hideTechnicians() {
        techniciansContainer.style.display = 'none';
      }
      
      function generateAssignmentPreview() {
        const selectedTeam = teamSelect.value;
        if (!selectedTeam || !teamsData[selectedTeam]) return;
        
        const team = teamsData[selectedTeam];
        const clientCount = selectedRows.size;
        const autoDistribute = document.getElementById('autoDistribute').checked;
        const considerWorkload = document.getElementById('considerWorkload').checked;
        
        let assignment = {};
        
        if (autoDistribute) {
          // Distribuci√≥n autom√°tica
          let technicians = [...team.technicians];
          
          if (considerWorkload) {
            // Ordenar por menor carga de trabajo
            technicians.sort((a, b) => a.workload - b.workload);
          }
          
          // Distribuir clientes entre t√©cnicos
          const baseAssignment = Math.floor(clientCount / technicians.length);
          const remainder = clientCount % technicians.length;
          
          technicians.forEach((tech, index) => {
            assignment[tech.name] = baseAssignment + (index < remainder ? 1 : 0);
          });
        } else {
          // Distribuci√≥n uniforme simple
          const perTechnician = Math.ceil(clientCount / team.technicians.length);
          team.technicians.forEach(tech => {
            assignment[tech.name] = Math.min(perTechnician, clientCount);
          });
        }
        
        // Mostrar vista previa
        previewContent.innerHTML = '';
        Object.keys(assignment).forEach(techName => {
          const assignmentDiv = document.createElement('div');
          assignmentDiv.className = 'preview-assignment';
          assignmentDiv.innerHTML = `
            <span class="preview-tech">${techName}</span>
            <span class="preview-count">${assignment[techName]} clientes</span>
          `;
          previewContent.appendChild(assignmentDiv);
        });
        
        assignmentPreview.style.display = 'block';
        confirmAssignmentBtn.disabled = false;
      }
      
      function confirmTeamAssignment() {
        const selectedTeam = teamSelect.value;
        const teamName = teamsData[selectedTeam].name;
        const selectedCount = selectedRows.size;
        
        // Simular asignaci√≥n
        confirmAssignmentBtn.innerHTML = '‚è≥ Asignando...';
        confirmAssignmentBtn.disabled = true;
        
        setTimeout(() => {
          // Marcar filas como asignadas (agregar columna visual)
          displayedData.forEach((row, idx) => {
            if (selectedRows.has(idx)) {
              row._assignedTeam = teamName;
              row._assignedDate = new Date().toISOString().split('T')[0];
            }
          });
          
          // Actualizar tabla
          renderTable(displayedData);
          
          // Limpiar selecci√≥n
          selectedRows.clear();
          
          // Cerrar panel
          teamAssignmentPanel.style.display = 'none';
          
          // Mostrar mensaje de √©xito
          alert(`${selectedCount} Kunden erfolgreich zu ${teamName} zugewiesen!`);
          
          confirmAssignmentBtn.innerHTML = '‚úÖ Confirmar Asignaci√≥n';
        }, 2000);
      }
      
      function resetTeamAssignment() {
        teamSelect.value = '';
        hideTechnicians();
        assignmentPreview.style.display = 'none';
        previewAssignmentBtn.disabled = true;
        confirmAssignmentBtn.disabled = true;
        document.getElementById('autoDistribute').checked = true;
        document.getElementById('considerWorkload').checked = false;
        document.getElementById('geographicProximity').checked = true;
      }
      
      // Exportar datos seleccionados
      exportSelectedBtn.addEventListener('click', function() {
        if (selectedRows.size === 0) return;
        
        const selectedData = displayedData.filter((_, idx) => selectedRows.has(idx));
        const csv = Papa.unparse(selectedData);
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', `clientes_seleccionados_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });
      
      // Eliminar clientes seleccionados
      deleteSelectedBtn.addEventListener('click', function() {
        if (selectedRows.size === 0) return;
        
        if (confirm(`¬øEst√°s seguro de que quieres eliminar ${selectedRows.size} cliente(s) seleccionado(s)?`)) {
          // Filtrar datos eliminando los seleccionados
          const indicesToDelete = new Set([...selectedRows]);
          rawData = rawData.filter((_, idx) => !indicesToDelete.has(idx));
          
          // Limpiar selecci√≥n
          selectedRows.clear();
          
          // Reaplican filtros
          applyFilters();
        }
      });
      
      // Agendar masivo
      bulkScheduleBtn.addEventListener('click', function() {
        if (selectedRows.size === 0) return;
        
        const selectedData = displayedData.filter((_, idx) => selectedRows.has(idx));
        const nameCol = getColumnName(['nombre','name','cliente','cliente_nombre'], headers);
        
        // Abrir ventanas para cada cliente seleccionado
        selectedData.forEach((row, index) => {
          setTimeout(() => {
            const clientName = nameCol ? row[nameCol] : `Cliente ${index + 1}`;
            localStorage.setItem('bot_client_name', clientName || '');
            window.open('./conversations.html', '_blank');
          }, index * 500); // Delay entre ventanas
        });
      });
      
      // Sincronizaci√≥n con sistema externo
      const syncExternalBtn = document.getElementById('syncExternalBtn');
      const integrationPanel = document.getElementById('integrationPanel');
      const closePanelBtn = document.getElementById('closePanelBtn');
      const forceSyncBtn = document.getElementById('forceSyncBtn');
      const testConnectionBtn = document.getElementById('testConnectionBtn');
      
      syncExternalBtn.addEventListener('click', function() {
        integrationPanel.style.display = 'block';
        updateIntegrationStatus();
      });
      
      // Actualizar contador de clientes seleccionados para equipos
      function updateTeamAssignmentCount() {
        if (document.getElementById('selectedClientsCount')) {
          document.getElementById('selectedClientsCount').textContent = selectedRows.size;
        }
      }
      
      closePanelBtn.addEventListener('click', function() {
        integrationPanel.style.display = 'none';
      });
      
      forceSyncBtn.addEventListener('click', function() {
        this.innerHTML = 'üîÑ Sincronizando...';
        this.disabled = true;
        
        // Simular proceso de sincronizaci√≥n
        setTimeout(() => {
          this.innerHTML = '‚úÖ Sincronizaci√≥n Completa';
          
          setTimeout(() => {
            this.innerHTML = 'üîÑ Forzar Sincronizaci√≥n Completa';
            this.disabled = false;
            updateIntegrationStatus();
          }, 2000);
        }, 3000);
      });
      
      testConnectionBtn.addEventListener('click', function() {
        this.innerHTML = 'üîç Probando...';
        this.disabled = true;
        
        setTimeout(() => {
          this.innerHTML = '‚úÖ Conexi√≥n Exitosa';
          
          setTimeout(() => {
            this.innerHTML = 'üîç Probar Conexi√≥n';
            this.disabled = false;
          }, 2000);
        }, 1500);
      });
      
      // Actualizar estado de integraci√≥n
      function updateIntegrationStatus() {
        const lastSync = document.getElementById('lastSync');
        const syncedCount = document.getElementById('syncedCount');
        
        // Simular actualizaci√≥n de timestamps
        const now = new Date();
        lastSync.textContent = 'Ahora mismo';
        
        setTimeout(() => {
          lastSync.textContent = 'Hace 1 minuto';
        }, 60000);
        
        // Actualizar contador de sincronizados
        if (rawData.length > 0) {
          const total = rawData.length;
          const synced = Math.floor(total * 0.98); // 98% sincronizados
          syncedCount.textContent = `${synced} / ${total}`;
        }
      }
      
      // Cargar archivo CSV
      csvFile.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        
        showLoading();
        
        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: function(results) {
            rawData = results.data;
            displayedData = [...rawData];
            headers = results.meta.fields || [];
            selectedRows.clear();
            
            if (rawData.length === 0) {
              showEmpty();
              return;
            }
            
            // Configurar tabla
            setupTableHeaders();
            updateFilters(headers, rawData);
            
            // Activar filtro "Todos" por defecto
            updateQuickFilterUI(filterAll);
            
            renderTable(displayedData);
          },
          error: function(err) {
            showEmpty();
            alert('Error al leer CSV: ' + err.message);
          }
        });
      });
      
      // Mostrar estado inicial
      showEmpty();
      updateQuickFilterUI(filterAll);
    })();
  </script>
</body>
</html>