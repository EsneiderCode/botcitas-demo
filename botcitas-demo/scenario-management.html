<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>WhatsApp - Gesti√≥n de Citas</title>
        <!-- Integraci√≥n de @sneas/telephone -->
        <script defer
            src="https://cdn.jsdelivr.net/npm/@sneas/telephone@1/iphone-16-max.js"></script>
        <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Segoe UI", "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: #3b4a54;
            overflow: hidden;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* ========== PHONE CONTAINER ========== */
        .phone-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            width: 100vw;
            gap: 40px;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .phone-wrapper.single-phone {
            justify-content: center;
        }

        .phone-wrapper.dual-phone {
            justify-content: center;
            padding: 0 60px;
            gap: 80px;
        }

        .phone-container {
            position: relative;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .phone-container.client-phone {
            transform: translateX(0);
        }

        .phone-container.client-phone.moved-left {
            transform: translateX(-120px);
        }

        .phone-container.technician-phone {
            opacity: 0;
            transform: translateX(100px);
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .phone-container.technician-phone.show {
            opacity: 1;
            transform: translateX(0);
        }

        iphone-16-max {
            --frame-color: #1d1d1f;
            transform: scale(0.85);
            filter: drop-shadow(0 25px 50px rgba(0,0,0,0.3));
            transition: all 0.3s ease;
        }

        /* Asegurar que ambos tel√©fonos tengan el mismo tama√±o */
        .phone-container client-phone iphone-16-max,
        .phone-container technician-phone iphone-16-max {
            transform: scale(0.85) !important;
        }

        .phone-label {
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            backdrop-filter: blur(10px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .phone-container.show-label .phone-label {
            opacity: 1;
        }

        /* ========== WHATSAPP CONTENT ========== */
        .whatsapp-content {
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #ffffff;
            position: relative;
            overflow: hidden;
            /* Padding para respetar el status bar del iPhone */
            padding-top: 47px;
        }

        .chat-header {
            background: #f0f2f5;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            height: 56px;
            color: #111b21;
            flex-shrink: 0;
            border-bottom: 1px solid #e9edef;
        }

        .header-back-btn {
            background-image: url('https://prankshit.com/es/whatsapp/images/iphone-arrow.webp');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;
            padding: 4px;
            margin-left: -4px;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
            border: none;
            background-color: transparent;
        }

        .header-back-btn:hover {
            background-color: rgba(84, 101, 111, 0.1);
        }

        .chat-contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-image: url('clarity.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
        }

        .chat-contact-info {
            flex: 1;
            min-width: 0;
        }

        .chat-contact-name {
            font-size: 14px;
            font-weight: 400;
            color: #111b21;
            margin-bottom: 2px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
            min-height: 20px;
        }
        
        .chat-contact-name-text {
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0;
        }

        .verified-badge {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #1da1f2;
            border-radius: 50%;
            color: white;
            font-size: 10px;
            font-weight: bold;
            position: relative;
        }
        
        .verified-badge::before {
            content: "‚úì";
            display: inline-block;
        }

        .chat-status {
            font-size: 12px;
            color: #667781;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
            align-items: center;
        }

        .call-video-icons {
            background-image: url('https://prankshit.com/es/whatsapp/images/iphone-header-left.webp');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            width: 45px;
            height: 18px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            transition: opacity 0.2s;
        }

        .call-video-icons:hover {
            opacity: 0.7;
        }

        .chat-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: transparent;
            border: none;
            color: #54656f;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            font-size: 16px;
            padding: 0;
        }

        .chat-btn:hover {
            background: rgba(84, 101, 111, 0.1);
        }

        .menu-icon::before {
            content: "‚ãÆ";
            font-size: 18px;
            font-weight: bold;
        }

        .chat-messages {
            flex: 1;
            /* Fondo real de WhatsApp desde imagen */
            background-color: #e5ddd5;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-size: 512px 512px;
            background-repeat: repeat;
            background-position: 0 0;
            padding: 16px 12px;
            overflow-y: auto;
            position: relative;
        }

        .message {
            margin-bottom: 12px;
            display: flex;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message.received {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 75%;
            min-width: 80px;
            position: relative;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
        }

        .message.received .message-bubble {
            background: #ffffff;
            border-radius: 7.5px 7.5px 7.5px 0;
            color: #111b21;
        }

        .message.sent .message-bubble {
            background: #d9fdd3;
            border-radius: 7.5px 7.5px 0 7.5px;
            color: #111b21;
        }

        .message-content {
            padding: 6px 7px 8px 9px;
            word-wrap: break-word;
            font-size: 14.2px;
            line-height: 19px;
        }

        .message-info {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 4px;
            margin-top: 4px;
            padding: 0 7px 6px;
        }

        .message-timestamp {
            font-size: 11px;
            color: #667781;
            white-space: nowrap;
        }

        .message.sent .message-timestamp {
            color: #667781;
        }

        .message-status-icon {
            background-image: url('https://prankshit.com/es/whatsapp/images/check-read.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            width: 16px;
            height: 12px;
            display: inline-block;
            margin-left: 4px;
        }

        /* Input area aut√©ntico */
        .iphone_footer_content {
            width: 100%;
            display: flex;
            align-items: center;
            padding: 8px 0;
            background: #f0f2f5;
            border-top: 1px solid #e9edef;
            flex-shrink: 0;
        }

        .iphone_footer_img {
            margin-right: 10px;
            margin-left: 10px;
        }

        .iphone_footer_img img {
            height: 18px;
            width: auto;
            cursor: pointer;
        }

        .iphone_footer_text_input {
            flex-grow: 1;
            display: flex;
            align-items: center;
            background-color: white;
            border: 0.2px solid #b2b2b2b0;
            border-radius: 20px;
            padding: 5px 10px;
            min-height: 35px;
            position: relative;
        }

        .chat-input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 13px;
            color: #3b4a54;
            background: transparent;
            padding: 5px;
            max-width: 125px;
        }

        .chat-input::placeholder {
            color: #8696a0;
        }

        .iphone_footer_whatsapp_recoder {
            margin-left: auto;
        }

        .iphone_footer_whatsapp_recoder img {
            height: 18px;
            width: auto;
            cursor: pointer;
        }

        .iphone_footer_whatsapp_comment_bar {
            margin-left: 10px;
            margin-right: 10px;
        }

        .iphone_footer_whatsapp_comment_bar img {
            height: 21px;
            width: auto;
            cursor: pointer;
        }

        .chat-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: calc(100% - 47px);
            flex-direction: column;
            color: #667781;
            text-align: center;
            gap: 20px;
            padding: 20px;
        }

        .placeholder-icon {
            font-size: 100px;
            opacity: 0.3;
            color: #667781;
        }

        .placeholder-text {
            font-size: 24px;
            font-weight: 300;
            margin-bottom: 10px;
            color: #667781;
        }

        .placeholder-subtitle {
            font-size: 14px;
            color: #8696a0;
            line-height: 20px;
            max-width: 300px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667781;
            font-size: 14px;
        }

        /* Scrollbar personalizado */
        .chat-messages::-webkit-scrollbar {
            width: 4px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
            border-radius: 2px;
        }

        /* Bot√≥n de navegaci√≥n */
        .nav-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            color: #075e54;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            z-index: 1000;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            background: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            iphone-16-max {
                transform: scale(0.7);
            }
            
            body {
                padding: 10px;
            }

            .phone-wrapper.dual-phone {
                padding: 0 20px;
                gap: 40px;
            }

            .phone-container.client-phone.moved-left {
                transform: translateX(-80px);
            }

            .phone-container.technician-phone {
                transform: translateX(50px);
            }

            .phone-container.technician-phone.show {
                transform: translateX(0);
            }

            /* Asegurar mismo tama√±o en responsive */
            .phone-container client-phone iphone-16-max,
            .phone-container technician-phone iphone-16-max {
                transform: scale(0.7) !important;
            }
        }

        @media (max-width: 480px) {
            iphone-16-max {
                transform: scale(0.6);
            }
            
            .nav-btn {
                top: 10px;
                left: 10px;
                padding: 8px 16px;
                font-size: 12px;
            }

            .phone-wrapper.dual-phone {
                flex-direction: column;
                gap: 40px;
                padding: 20px;
            }

            .phone-container.client-phone.moved-left {
                transform: translateY(-30px);
            }

            .phone-container.technician-phone {
                transform: translateY(50px);
            }

            .phone-container.technician-phone.show {
                transform: translateY(0);
            }

            /* Asegurar mismo tama√±o en mobile */
            .phone-container client-phone iphone-16-max,
            .phone-container technician-phone iphone-16-max {
                transform: scale(0.6) !important;
            }
        }

        /* Asegurar que el contenido llene el tel√©fono */
        iphone-16-max::part(content) {
            height: 100%;
            overflow: hidden;
        }

        /* Botones de respuesta r√°pida - Estilo WhatsApp Business API oficial */
        .quick-replies {
            padding: 8px 12px 12px 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            background: transparent;
            max-height: 200px;
            overflow-y: auto;
        }

        .quick-reply-button {
            background: transparent;
            border: 1px solid #d1d7db;
            border-radius: 20px;
            padding: 8px 12px;
            font-size: 13px;
            font-weight: 400;
            color: #0084ff;
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: center;
            min-height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 16px;
            box-shadow: none;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        .quick-reply-button:hover {
            background: rgba(0, 132, 255, 0.05);
            border-color: #0084ff;
        }

        .quick-reply-button:active {
            background: rgba(0, 132, 255, 0.1);
            transform: scale(0.98);
        }

        .quick-reply-button.selected {
            background: rgba(0, 132, 255, 0.1);
            border-color: #0084ff;
            color: #0084ff;
        }

        /* Botones en fila para algunas opciones */
        .quick-replies.horizontal {
            flex-direction: row;
            flex-wrap: wrap;
            gap: 8px;
        }

        .quick-replies.horizontal .quick-reply-button {
            flex: 1;
            min-width: 100px;
            max-width: 140px;
        }

        /* Estilo especial para botones de confirmaci√≥n - mantiene el azul est√°ndar */
        .quick-reply-button.confirm {
            background: #0084ff;
            color: white;
            border-color: #0084ff;
            font-weight: 500;
        }

        .quick-reply-button.confirm:hover {
            background: #0066cc;
            border-color: #0066cc;
        }

        .quick-reply-button.cancel {
            background: transparent;
            color: #0084ff;
            border-color: #d1d7db;
        }

        .quick-reply-button.cancel:hover {
            background: rgba(0, 132, 255, 0.05);
            border-color: #0084ff;
        }

        /* Ajuste para que se vean como botones reales de WhatsApp */
        .quick-reply-button:not(.horizontal) {
            max-width: 100%;
        }
    </style>
    </head>
    <body>
        <a href="/" class="nav-btn">
            üìä Panel Principal
        </a>

        <div class="phone-wrapper single-phone" id="phoneWrapper">
            <!-- Tel√©fono del Cliente -->
            <div class="phone-container client-phone" id="clientPhoneContainer">
                <div class="phone-label">Cliente</div>
                <iphone-16-max mode="light">
                    <div class="whatsapp-content">
                        <div class="chat-placeholder" id="chatPlaceholder">
                            <div class="placeholder-icon">üí¨</div>
                            <div class="placeholder-text">WhatsApp</div>
                            <div class="placeholder-subtitle">
                                Selecciona una conversaci√≥n para comenzar a chatear
                            </div>
                        </div>

                        <div id="chatContent"
                            style="display: none; height: 100%; flex-direction: column;">
                            <div class="chat-header" id="chatHeader">
                                <!-- Header del chat se cargar√° aqu√≠ -->
                            </div>
                            <div class="chat-messages" id="chatMessages">
                                <!-- Mensajes se cargar√°n aqu√≠ -->
                            </div>
                            <div class="quick-replies" id="quickReplies"
                                style="display: none;">
                                <!-- Botones de respuesta r√°pida se cargar√°n aqu√≠ -->
                            </div>
                            <div class="iphone_footer_content">
                                <div class="iphone_footer_img">
                                    <img
                                        src="https://prankshit.com/es/whatsapp/images/plus-whatsapp.png"
                                        alt="Plus WhatsApp">
                                </div>
                                <div class="iphone_footer_text_input">
                                    <input type="text" class="chat-input"
                                        placeholder="Escribe un mensaje">
                                    <div class="iphone_footer_whatsapp_recoder">
                                        <img
                                            src="https://prankshit.com/es/whatsapp/images/page-whatsapp.png"
                                            alt="Recorder WhatsApp">
                                    </div>
                                </div>
                                <div class="iphone_footer_whatsapp_comment_bar">
                                    <img
                                        src="https://prankshit.com/es/whatsapp/images/icone-whatsapp.png"
                                        alt="Send WhatsApp">
                                </div>
                            </div>
                        </div>
                    </div>
                </iphone-16-max>
            </div>

            <!-- Tel√©fono del T√©cnico -->
            <div class="phone-container technician-phone" id="technicianPhoneContainer">
                <div class="phone-label">T√©cnico</div>
                <iphone-16-max mode="light">
                    <div class="whatsapp-content">
                        <div class="chat-placeholder" id="technicianChatPlaceholder">
                            <div class="placeholder-icon">üîß</div>
                            <div class="placeholder-text">WhatsApp</div>
                            <div class="placeholder-subtitle">
                                Esperando notificaci√≥n...
                            </div>
                        </div>

                        <div id="technicianChatContent"
                            style="display: none; height: 100%; flex-direction: column;">
                            <div class="chat-header" id="technicianChatHeader">
                                <!-- Header del chat del t√©cnico se cargar√° aqu√≠ -->
                            </div>
                            <div class="chat-messages" id="technicianChatMessages">
                                <!-- Mensajes del t√©cnico se cargar√°n aqu√≠ -->
                            </div>
                            <div class="quick-replies" id="technicianQuickReplies"
                                style="display: none;">
                                <!-- Botones de respuesta r√°pida del t√©cnico se cargar√°n aqu√≠ -->
                            </div>
                            <div class="iphone_footer_content">
                                <div class="iphone_footer_img">
                                    <img
                                        src="https://prankshit.com/es/whatsapp/images/plus-whatsapp.png"
                                        alt="Plus WhatsApp">
                                </div>
                                <div class="iphone_footer_text_input">
                                    <input type="text" class="chat-input"
                                        placeholder="Escribe un mensaje">
                                    <div class="iphone_footer_whatsapp_recoder">
                                        <img
                                            src="https://prankshit.com/es/whatsapp/images/page-whatsapp.png"
                                            alt="Recorder WhatsApp">
                                    </div>
                                </div>
                                <div class="iphone_footer_whatsapp_comment_bar">
                                    <img
                                        src="https://prankshit.com/es/whatsapp/images/icone-whatsapp.png"
                                        alt="Send WhatsApp">
                                </div>
                            </div>
                        </div>
                    </div>
                </iphone-16-max>
            </div>
        </div>

        <script>
        class WhatsAppManagementSimulation {
            constructor() {
                this.messages = [];
                this.technicianMessages = [];
                this.currentStep = 0;
                this.userInput = '';
                this.appointmentData = {};
                this.isWaitingForResponse = false;
                this.technicianPhoneVisible = false;
                
                // Estructura de datos con el historial predefinido
                this.conversationHistory = {
                    appointmentData: {
                        name: "Alejandro Herrera",
                        phone: "+49 151 1947 0267",
                        address: "Musterstra√üe 15, 10115 Berlin",
                        contractNumber: "DG-2024-89756",
                        appointmentId: "ABX30",
                        securityCode: "4821",
                        technicianName: "Markus K.",
                        selectedSlot: {
                            date: "Mittwoch, 3. September",
                            time: "09:00 ‚Äì 11:00"
                        },
                        reminder: true
                    },
                    messages: [
                        {
                            body: "üè† Hallo Alejandro Herrera!\n\nüì° CLARITY - Ihre Glasfaser-Installation ist bereit.\n\nüåê Bitte w√§hlen Sie Ihre Sprache:",
                            direction: "received",
                            timestamp: "2024-01-15T22:46:00.000Z"
                        },
                        {
                            body: "üá©üá™ Deutsch",
                            direction: "sent",
                            timestamp: "2024-01-15T22:46:00.000Z"
                        },
                        {
                            body: "üì° Ihre Glasfaser-Installation ist bereit.",
                            direction: "received",
                            timestamp: "2024-01-15T22:46:00.000Z"
                        },
                        {
                            body: "TERMIN vereinbaren üìÖ",
                            direction: "sent",
                            timestamp: "2024-01-15T22:46:00.000Z"
                        },
                        {
                            body: "‚è∞ W√§hlen:",
                            direction: "received",
                            timestamp: "2024-01-15T22:46:00.000Z"
                        },
                        {
                            body: "üìÜ Mittwoch, 3. September - üïê 09:00 ‚Äì 11:00",
                            direction: "sent",
                            timestamp: "2024-01-15T22:46:00.000Z"
                        },
                        {
                            body: "‚úÖ Mittwoch, 3. September, 09:00 ‚Äì 11:00\n\nBest√§tigen?",
                            direction: "received",
                            timestamp: "2024-01-15T22:46:00.000Z"
                        },
                        {
                            body: "Ja ‚úÖ",
                            direction: "sent",
                            timestamp: "2024-01-15T22:46:00.000Z"
                        },
                        {
                            body: "üéâ Best√§tigt: Mittwoch, 3. September, 09:00 ‚Äì 11:00\n\nErinnerung?",
                            direction: "received",
                            timestamp: "2024-01-15T22:46:00.000Z"
                        },
                        {
                            body: "Ja üîî",
                            direction: "sent",
                            timestamp: "2024-01-15T22:46:00.000Z"
                        },
                        {
                            body: "‚úÖ **Best√§tigt**\n\nüìÖ Mittwoch, 3. September, 09:00 ‚Äì 11:00\nüë®‚Äçüîß Techniker: Markus K.\nüÜî ID: ABX30\nüîê Code: 4821 (auch beim Techniker)\n\nüì≤ Erinnerung gesendet.",
                            direction: "received",
                            timestamp: "2024-01-15T22:46:00.000Z"
                        }
                    ]
                };
                
                this.initializeSimulation();
                this.setupEventListeners();
            }

            initializeSimulation() {
                console.log('Initializing management simulation...');
                // Mostrar el chat inmediatamente
                this.showChatInterface();
                
                // Cargar historial predefinido
                setTimeout(() => {
                    this.loadConversationHistory();
                }, 1000);
            }

            setupEventListeners() {
                const chatInput = document.querySelector('.chat-input');
                const sendButton = document.querySelector('.iphone_footer_whatsapp_comment_bar img');
                
                // Enviar mensaje con Enter
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !this.isWaitingForResponse) {
                        this.sendUserMessage(chatInput.value.trim());
                        chatInput.value = '';
                    }
                });
                
                // Enviar mensaje con bot√≥n
                sendButton.addEventListener('click', () => {
                    if (!this.isWaitingForResponse) {
                        this.sendUserMessage(chatInput.value.trim());
                        chatInput.value = '';
                    }
                });
            }

            showQuickReplies(options) {
                const quickRepliesContainer = document.getElementById('quickReplies');
                
                if (!options || options.length === 0) {
                    quickRepliesContainer.style.display = 'none';
                    return;
                }

                quickRepliesContainer.innerHTML = '';
                quickRepliesContainer.style.display = 'flex';
                
                // Agregar clase horizontal para ciertas opciones
                if (options.some(opt => opt.horizontal)) {
                    quickRepliesContainer.className = 'quick-replies horizontal';
                } else {
                    quickRepliesContainer.className = 'quick-replies';
                }

                options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = `quick-reply-button ${option.type || ''}`;
                    button.textContent = option.text;
                    button.onclick = () => this.handleQuickReply(option.value || option.text);
                    quickRepliesContainer.appendChild(button);
                });
            }

            hideQuickReplies() {
                const quickRepliesContainer = document.getElementById('quickReplies');
                quickRepliesContainer.style.display = 'none';
            }

            async handleQuickReply(value) {
                this.hideQuickReplies();
                await this.sendUserMessage(value);
            }

            showChatInterface() {
                const chatPlaceholder = document.getElementById('chatPlaceholder');
                const chatContent = document.getElementById('chatContent');
                const chatHeader = document.getElementById('chatHeader');
                
                chatPlaceholder.style.display = 'none';
                chatContent.style.display = 'flex';

                // Header del chat
                chatHeader.innerHTML = `
                    <button class="header-back-btn" title="Volver"></button>
                    <div class="chat-contact-avatar"></div>
                    <div class="chat-contact-info">
                        <div class="chat-contact-name">
                            <span class="chat-contact-name-text">CLARITY</span>
                            <div class="verified-badge"></div>
                        </div>
                        <div class="chat-status">En l√≠nea</div>
                    </div>
                    <div class="chat-actions">
                        <button class="call-video-icons" title="Llamada y Videollamada"></button>
                        <button class="chat-btn menu-icon" title="M√°s opciones"></button>
                    </div>
                `;
            }

            showTechnicianPhone() {
                if (this.technicianPhoneVisible) return;
                
                this.technicianPhoneVisible = true;
                const phoneWrapper = document.getElementById('phoneWrapper');
                const clientPhoneContainer = document.getElementById('clientPhoneContainer');
                const technicianPhoneContainer = document.getElementById('technicianPhoneContainer');
                
                // Cambiar layout a dual-phone
                phoneWrapper.classList.remove('single-phone');
                phoneWrapper.classList.add('dual-phone');
                
                // Mover tel√©fono del cliente a la izquierda
                clientPhoneContainer.classList.add('moved-left');
                
                // Mostrar etiquetas
                clientPhoneContainer.classList.add('show-label');
                
                // Mostrar tel√©fono del t√©cnico con animaci√≥n
                setTimeout(() => {
                    technicianPhoneContainer.classList.add('show');
                    technicianPhoneContainer.classList.add('show-label');
                    
                    // Inicializar chat del t√©cnico
                    this.initializeTechnicianChat();
                }, 400);
            }

            initializeTechnicianChat() {
                const technicianChatPlaceholder = document.getElementById('technicianChatPlaceholder');
                const technicianChatContent = document.getElementById('technicianChatContent');
                const technicianChatHeader = document.getElementById('technicianChatHeader');
                
                technicianChatPlaceholder.style.display = 'none';
                technicianChatContent.style.display = 'flex';

                // Header del chat del t√©cnico
                technicianChatHeader.innerHTML = `
                    <button class="header-back-btn" title="Volver"></button>
                    <div class="chat-contact-avatar"></div>
                    <div class="chat-contact-info">
                        <div class="chat-contact-name">
                            <span class="chat-contact-name-text">CLARITY System</span>
                            <div class="verified-badge"></div>
                        </div>
                        <div class="chat-status">En l√≠nea</div>
                    </div>
                    <div class="chat-actions">
                        <button class="call-video-icons" title="Llamada y Videollamada"></button>
                        <button class="chat-btn menu-icon" title="M√°s opciones"></button>
                    </div>
                `;
            }

            addTechnicianMessage(content, direction, delay = 0) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const timestamp = new Date();
                        const message = {
                            body: content,
                            direction: direction,
                            timestamp: timestamp.toISOString()
                        };
                        
                        this.technicianMessages.push(message);
                        this.renderTechnicianMessages();
                        resolve();
                    }, delay);
                });
            }

            renderTechnicianMessages() {
                const technicianChatMessages = document.getElementById('technicianChatMessages');
                
                technicianChatMessages.innerHTML = this.technicianMessages.map(msg => `
                    <div class="message ${msg.direction}">
                        <div class="message-bubble">
                            <div class="message-content">${msg.body}</div>
                            <div class="message-info">
                                <span class="message-timestamp">${this.formatMessageTime(msg.timestamp)}</span>
                                ${msg.direction === 'sent' ? '<span class="message-status-icon"></span>' : ''}
                            </div>
                        </div>
                    </div>
                `).join('');

                // Auto scroll
                setTimeout(() => {
                    technicianChatMessages.scrollTop = technicianChatMessages.scrollHeight;
                }, 50);
            }

            addMessage(content, direction, delay = 0) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const timestamp = new Date();
                        const message = {
                            body: content,
                            direction: direction,
                            timestamp: timestamp.toISOString()
                        };
                        
                        this.messages.push(message);
                        this.renderMessages();
                        resolve();
                    }, delay);
                });
            }

            renderMessages() {
                const chatMessages = document.getElementById('chatMessages');
                
                chatMessages.innerHTML = this.messages.map(msg => `
                    <div class="message ${msg.direction}">
                        <div class="message-bubble">
                            <div class="message-content">${msg.body}</div>
                            <div class="message-info">
                                <span class="message-timestamp">${this.formatMessageTime(msg.timestamp)}</span>
                                ${msg.direction === 'sent' ? '<span class="message-status-icon"></span>' : ''}
                            </div>
                        </div>
                    </div>
                `).join('');

                // Auto scroll
                setTimeout(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 50);
            }

            formatMessageTime(timestamp) {
                const date = new Date(timestamp);
                return date.toLocaleTimeString('es-ES', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            loadConversationHistory() {
                console.log('Loading conversation history...');
                
                // Cargar datos de la cita
                this.appointmentData = this.conversationHistory.appointmentData;
                
                // Cargar mensajes del historial
                this.messages = [...this.conversationHistory.messages];
                this.renderMessages();
                
                // Mostrar opciones de gesti√≥n
                setTimeout(() => {
                    this.showManagementOptions();
                }, 1500);
            }

                         showManagementOptions() {
                 // En gesti√≥n de citas siempre usar alem√°n
                 const buttons = [
                     { text: "üîÑ Termin √§ndern" },
                     { text: "‚ùå Termin stornieren" },
                     { text: "üìã Status pr√ºfen" }
                 ];
                 
                 this.showQuickReplies(buttons);
                 this.currentStep = 1; // Gesti√≥n de citas
             }

            async sendUserMessage(message) {
                if (!message || this.isWaitingForResponse) return;
                
                this.isWaitingForResponse = true;
                await this.addMessage(message, 'sent');
                
                // Procesar respuesta seg√∫n el paso actual
                await this.processUserResponse(message);
            }

            async processUserResponse(message) {
                console.log('Processing response:', message, 'Step:', this.currentStep);
                
                switch (this.currentStep) {
                                         case 1: // Gesti√≥n de citas
                         if (message.includes("√§ndern")) {
                             await this.addMessage("üîÑ Was m√∂chten Sie √§ndern?", 'received', 1000);
                             setTimeout(() => {
                                 this.showQuickReplies([
                                     { text: "üìÖ Datum √§ndern" },
                                     { text: "‚è∞ Uhrzeit √§ndern" },
                                     { text: "‚ùå √Ñnderung abbrechen" }
                                 ]);
                             }, 1500);
                             this.currentStep = 2; // Modificaci√≥n
                         } else if (message.includes("stornieren")) {
                             await this.addMessage("‚ùå Sind Sie sicher, dass Sie Ihren Termin stornieren m√∂chten?", 'received', 1000);
                             setTimeout(() => {
                                 this.showQuickReplies([
                                     { text: "‚úÖ Ja, stornieren" },
                                     { text: "‚ùå Nein, behalten" }
                                 ]);
                             }, 1500);
                             this.currentStep = 3; // Cancelaci√≥n
                        } else if (message.includes("Status pr√ºfen")) {
                            const slotText = `${this.appointmentData.selectedSlot.date}, ${this.appointmentData.selectedSlot.time}`;
                            const id = this.appointmentData.appointmentId || 'ABX30';
                            const code = this.appointmentData.securityCode || '4821';
                            const tech = this.appointmentData.technicianName || 'Techniker';
                            await this.addMessage(`üìã **Termin-Status:**

‚úÖ Best√§tigt
üìÖ ${slotText}
üë®‚Äçüîß Techniker: ${tech}
üÜî ID: ${id}
üîê Code: ${code} (auch beim Techniker)`, 'received', 1000);
                            this.currentStep = 4; // Estado
                        }
                         break;
                        
                                         case 2: // Modificaci√≥n
                         if (message.includes("Datum √§ndern")) {
                             await this.addMessage("üìÖ W√§hlen Sie ein neues Datum:", 'received', 1000);
                             setTimeout(() => {
                                 this.showQuickReplies([
                                     { text: "üìÜ Freitag, 5. September" },
                                     { text: "üìÜ Montag, 8. September" },
                                     { text: "‚ùå Abbrechen" }
                                 ]);
                             }, 1500);
                             this.currentStep = 5; // Selecci√≥n de fecha
                         } else if (message.includes("Uhrzeit √§ndern")) {
                             await this.addMessage("‚è∞ W√§hlen Sie eine neue Uhrzeit:", 'received', 1000);
                             setTimeout(() => {
                                 this.showQuickReplies([
                                     { text: "üïê 13:00 ‚Äì 15:00" },
                                     { text: "üïê 15:00 ‚Äì 17:00" },
                                     { text: "‚ùå Abbrechen" }
                                 ]);
                             }, 1500);
                             this.currentStep = 6; // Selecci√≥n de hora
                         } else if (message.includes("√Ñnderung abbrechen")) {
                             await this.addMessage("‚úÖ √Ñnderung abgebrochen. Ihr Termin bleibt unver√§ndert.", 'received', 1000);
                             setTimeout(() => {
                                 this.showManagementOptions();
                             }, 1500);
                             this.currentStep = 1;
                         }
                         break;
                         
                     case 3: // Cancelaci√≥n
                        if (message.includes("Ja, stornieren")) {
                            const id = this.appointmentData.appointmentId || 'ABX30';
                            const code = this.appointmentData.securityCode || '4821';
                            await this.addMessage(`‚ùå Ihr Termin wurde erfolgreich storniert.\n\nüÜî ID: ${id}\nüîê Code: ${code}`, 'received', 1000);
                             
                             // Mostrar tel√©fono del t√©cnico y notificar cancelaci√≥n
                             this.showTechnicianPhone();
                             
                            setTimeout(async () => {
                                const id = this.appointmentData.appointmentId || 'ABX30';
                                const code = this.appointmentData.securityCode || '4821';
                                await this.addTechnicianMessage("üîî **TERMIN STORNIERT**\n\nüìã Alejandro Herrera\nüìÖ Mittwoch, 3. September, 09:00 ‚Äì 11:00\nüÜî ID: " + id + "\nüîê Code: " + code + "\nüè† Musterstra√üe 15, 10115 Berlin\nüìû +49 151 1947 0267\n\n‚ùå Termin wurde vom Kunden storniert.", 'received', 500);
                                 
                                 setTimeout(() => {
                                     this.addTechnicianMessage("Verstanden. Termin aus meinem Kalender entfernt.", 'sent', 1000);
                                 }, 2000);
                             }, 1000);
                             
                             this.currentStep = 0; // Finalizado
                         } else if (message.includes("Nein, behalten")) {
                             await this.addMessage("‚úÖ Perfekt, Ihr Termin bleibt unver√§ndert.", 'received', 1000);
                             setTimeout(() => {
                                 this.showManagementOptions();
                             }, 1500);
                             this.currentStep = 1;
                         }
                         break;
                         
                    case 5: // Selecci√≥n de fecha
                        if (message.includes("Freitag, 5. September") || message.includes("Montag, 8. September")) {
                            // Guardar la nueva fecha seleccionada para usarla m√°s adelante
                            if (message.includes("Freitag, 5. September")) {
                                this.pendingNewDate = "Freitag, 5. September";
                            } else if (message.includes("Montag, 8. September")) {
                                this.pendingNewDate = "Montag, 8. September";
                            }
                            await this.addMessage("‚úÖ Neues Datum ausgew√§hlt. W√§hlen Sie eine neue Uhrzeit:", 'received', 1000);
                             setTimeout(() => {
                                 this.showQuickReplies([
                                     { text: "üïê 09:00 ‚Äì 11:00" },
                                     { text: "üïê 13:00 ‚Äì 15:00" },
                                     { text: "üïê 15:00 ‚Äì 17:00" }
                                 ]);
                             }, 1500);
                             this.currentStep = 6; // Selecci√≥n de hora
                         } else if (message.includes("Abbrechen")) {
                             await this.addMessage("‚úÖ √Ñnderung abgebrochen. Ihr Termin bleibt unver√§ndert.", 'received', 1000);
                             setTimeout(() => {
                                 this.showManagementOptions();
                             }, 1500);
                             this.currentStep = 1;
                         }
                         break;
                         
                    case 6: // Selecci√≥n de hora
                        if (message.includes("09:00") || message.includes("13:00") || message.includes("15:00")) {
                            const id = this.appointmentData.appointmentId || 'ABX30';
                            const code = this.appointmentData.securityCode || '4821';
                            // Determinar nueva hora y fecha
                            const newTime = message.includes("09:00") ? "09:00 ‚Äì 11:00" : 
                                           message.includes("13:00") ? "13:00 ‚Äì 15:00" : "15:00 ‚Äì 17:00";
                            const newDate = this.pendingNewDate || (this.appointmentData.selectedSlot && this.appointmentData.selectedSlot.date) || '';
                            // Actualizar datos de la cita
                            this.appointmentData.selectedSlot = { date: newDate || this.appointmentData.selectedSlot.date, time: newTime };
                            await this.addMessage(`‚úÖ Ihr Termin wurde erfolgreich ge√§ndert.\n\nüìÖ ${this.appointmentData.selectedSlot.date}, ${this.appointmentData.selectedSlot.time}\nüÜî ID: ${id}\nüîê Code: ${code}`, 'received', 1000);
                             
                             // Mostrar tel√©fono del t√©cnico y notificar cambio
                             this.showTechnicianPhone();
                             
                             setTimeout(async () => {
                                const id = this.appointmentData.appointmentId || 'ABX30';
                                const code = this.appointmentData.securityCode || '4821';
                                const techDate = this.appointmentData.selectedSlot.date || newDate;
                                await this.addTechnicianMessage("üîî **TERMIN GE√ÑNDERT**\n\nüìã Alejandro Herrera\nüìÖ Neues Datum: " + techDate + "\nüïê Neue Zeit: " + this.appointmentData.selectedSlot.time + "\nüÜî ID: " + id + "\nüîê Code: " + code + "\nüè† Musterstra√üe 15, 10115 Berlin\nüìû +49 151 1947 0267\n\n‚úÖ Termin wurde vom Kunden ge√§ndert.", 'received', 500);
                                 
                                 setTimeout(() => {
                                     this.addTechnicianMessage("Verstanden. Neuen Termin in meinem Kalender aktualisiert.", 'sent', 1000);
                                 }, 2000);
                             }, 1000);
                             
                             setTimeout(() => {
                                 this.showManagementOptions();
                             }, 1500);
                             this.currentStep = 1;
                         } else if (message.includes("Abbrechen")) {
                             await this.addMessage("‚úÖ √Ñnderung abgebrochen. Ihr Termin bleibt unver√§ndert.", 'received', 1000);
                             setTimeout(() => {
                                 this.showManagementOptions();
                             }, 1500);
                             this.currentStep = 1;
                         }
                         break;
                        
                    default:
                        await this.addMessage("Danke. Kann ich Ihnen noch bei etwas anderem helfen?", 'received', 1000);
                        break;
                }
                
                this.isWaitingForResponse = false;
            }
        }

        // Inicializar la simulaci√≥n cuando cargue la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing management simulation...');
            window.managementApp = new WhatsAppManagementSimulation();
        });
        </script>
    </body>
</html>
