<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configuración del Sistema - Bot de Citas CLARITY</title>
  <link rel="stylesheet" href="./css/styles.css">
  <style>
    .settings-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }
    
    .settings-header {
      text-align: center;
      margin-bottom: 40px;
    }
    
    .settings-header h1 {
      margin: 0 0 8px;
      font-size: 2.2rem;
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
    }
    
    .config-section {
      background: var(--card);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      border: 1px solid #2c4a5e;
    }
    
    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #2c4a5e;
    }
    
    .section-icon {
      font-size: 1.5rem;
    }
    
    .section-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--text);
      margin: 0;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text);
      font-weight: 600;
      font-size: 0.95rem;
    }
    
    .form-group input[type="number"],
    .form-group input[type="text"],
    .form-group input[type="url"],
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 16px;
      border-radius: 12px;
      border: 2px solid #2c4a5e;
      background: #173140;
      color: var(--text);
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #8b5cf6;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
    }
    
    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #8b5cf6;
    }
    
    .checkbox-item label {
      margin: 0;
      font-weight: 500;
      color: var(--muted);
    }
    
    .input-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    .actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      justify-content: flex-end;
    }
    
    .actions button {
      background: #173140;
      color: var(--text);
      border: 2px solid #2c4a5e;
      padding: 12px 24px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .actions button:hover {
      border-color: #8b5cf6;
      transform: translateY(-2px);
    }
    
    .actions button.primary {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
      border-color: #8b5cf6;
    }
    
    .msg {
      margin-top: 16px;
      padding: 12px 16px;
      border-radius: 10px;
      font-weight: 600;
      text-align: center;
    }
    
    .msg.success {
      background: rgba(34, 197, 94, 0.1);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }
    
    .msg.error {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }
    
    .integration-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: #0f1b23;
      border-radius: 10px;
      margin-bottom: 16px;
    }
    
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    .status-connected {
      background: #22c55e;
    }
    
    .status-disconnected {
      background: #ef4444;
    }
    
    .test-connection {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
      border: 2px solid #3b82f6;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.2s ease;
      margin-top: 12px;
    }
    
    .test-connection:hover {
      background: #3b82f6;
      color: white;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    @media (max-width: 768px) {
      .settings-container {
        padding: 16px;
      }
      
      .settings-grid {
        grid-template-columns: 1fr;
      }
      
      .input-group {
        grid-template-columns: 1fr;
      }
      
      .actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body class="page with-navbar">
  <nav class="navbar">
    <a href="./index.html" class="navbar-brand">
      ⚙️ Bot de Citas CLARITY
    </a>
    <div class="navbar-nav">
      <a href="./index.html" class="nav-link">Inicio</a>
      <a href="./conversations.html" class="nav-link">Demo</a>
      <a href="./manager.html" class="nav-link">Gestor</a>
      <a href="./dashboard.html" class="nav-link">Dashboard</a>
      <a href="./settings.html" class="nav-link active">Config</a>
    </div>
  </nav>
  
  <div class="settings-container">
    <div class="settings-header">
      <h1>⚙️ Configuración del Sistema</h1>
      <p>Configura parámetros del bot, integraciones y sincronización con sistemas externos</p>
    </div>
    
    <div class="settings-grid">
      <!-- Configuración de Integración -->
      <div class="config-section">
        <div class="section-header">
          <span class="section-icon">🔗</span>
          <h2 class="section-title">Integración Externa</h2>
        </div>
        
        <div class="integration-status">
          <div class="status-indicator status-connected" id="integrationIndicator"></div>
          <span id="integrationStatusText">Conectado al sistema de citas</span>
        </div>
        
        <div class="form-group">
          <label for="apiEndpoint">URL del API de Citas</label>
          <input type="url" id="apiEndpoint" placeholder="https://api.sistema-citas.com/v1" value="https://api.sistema-citas.com/v1">
        </div>
        
        <div class="form-group">
          <label for="apiKey">Clave de API</label>
          <input type="text" id="apiKey" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxx" value="sk-demo-key-12345">
        </div>
        
        <div class="form-group">
          <label for="syncInterval">Intervalo de Sincronización</label>
          <select id="syncInterval">
            <option value="1">Cada minuto</option>
            <option value="5" selected>Cada 5 minutos</option>
            <option value="15">Cada 15 minutos</option>
            <option value="30">Cada 30 minutos</option>
            <option value="60">Cada hora</option>
          </select>
        </div>
        
        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="autoSync" checked>
            <label for="autoSync">Sincronización automática habilitada</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="bidirectionalSync" checked>
            <label for="bidirectionalSync">Sincronización bidireccional</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="retryFailedSync">
            <label for="retryFailedSync">Reintentar sincronizaciones fallidas</label>
          </div>
        </div>
        
        <button class="test-connection" id="testIntegration">
          🔍 Probar Conexión
        </button>
      </div>
      
      <!-- Configuración del Bot -->
      <div class="config-section">
        <div class="section-header">
          <span class="section-icon">🤖</span>
          <h2 class="section-title">Parámetros del Bot</h2>
        </div>
        
        <div class="form-group">
          <label for="retryCount">Número de reintentos automáticos</label>
          <input type="number" id="retryCount" min="1" max="10" step="1" value="5">
        </div>
        
        <div class="form-group">
          <label for="responseTimeout">Tiempo límite de respuesta (segundos)</label>
          <input type="number" id="responseTimeout" min="5" max="300" value="30">
        </div>
        
        <div class="form-group">
          <label for="cancelPolicy">Política de cancelación</label>
          <textarea id="cancelPolicy" placeholder="Cancelación sin coste hasta 24 horas antes de la cita programada.">Cancelación sin coste hasta 24 horas antes de la cita programada.</textarea>
        </div>
        
        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="useName" checked>
            <label for="useName">Incluir nombre del cliente en calendario</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="sendReminders" checked>
            <label for="sendReminders">Enviar recordatorios automáticos</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="logConversations">
            <label for="logConversations">Registrar conversaciones para análisis</label>
          </div>
        </div>
      </div>
      
      <!-- Horarios de Disponibilidad -->
      <div class="config-section">
        <div class="section-header">
          <span class="section-icon">🕐</span>
          <h2 class="section-title">Horarios Disponibles</h2>
        </div>
        
        <div class="form-group">
          <label>Slot de Mañana</label>
          <div class="input-group">
            <input type="text" id="slot1start" placeholder="09:00" value="09:00">
            <input type="text" id="slot1end" placeholder="12:00" value="12:00">
          </div>
        </div>
        
        <div class="form-group">
          <label>Slot de Tarde</label>
          <div class="input-group">
            <input type="text" id="slot2start" placeholder="14:00" value="14:00">
            <input type="text" id="slot2end" placeholder="18:00" value="18:00">
          </div>
        </div>
        
        <div class="form-group">
          <label for="excludedDates">Fechas excluidas (separadas por comas)</label>
          <input type="text" id="excludedDates" placeholder="2024-12-25, 2024-01-01">
        </div>
        
        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="includeWeekends">
            <label for="includeWeekends">Incluir fines de semana</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="dynamicSlots" checked>
            <label for="dynamicSlots">Ajustar horarios según ocupación</label>
          </div>
        </div>
      </div>
      
      <!-- Configuración de Notificaciones -->
      <div class="config-section">
        <div class="section-header">
          <span class="section-icon">🔔</span>
          <h2 class="section-title">Notificaciones</h2>
        </div>
        
        <div class="form-group">
          <label for="reminderTime">Recordatorio antes de la cita (horas)</label>
          <select id="reminderTime">
            <option value="2">2 horas</option>
            <option value="4">4 horas</option>
            <option value="24" selected>24 horas</option>
            <option value="48">48 horas</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="adminEmail">Email del administrador</label>
          <input type="email" id="adminEmail" placeholder="admin@empresa.com">
        </div>
        
        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="emailNotifications" checked>
            <label for="emailNotifications">Notificaciones por email</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="smsNotifications">
            <label for="smsNotifications">Notificaciones por SMS</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="webhookNotifications">
            <label for="webhookNotifications">Webhooks para eventos</label>
          </div>
        </div>
      </div>
    </div>
    
    <div class="actions">
      <button type="button" id="btnReset">Restablecer por Defecto</button>
      <button type="button" id="btnSave" class="primary">Guardar Configuración</button>
    </div>
    
    <div class="msg" id="msg"></div>
  </div>

  <script>
    (function() {
      // Referencias a elementos del DOM
      const msg = document.getElementById('msg');
      
      // Elementos de integración
      const apiEndpoint = document.getElementById('apiEndpoint');
      const apiKey = document.getElementById('apiKey');
      const syncInterval = document.getElementById('syncInterval');
      const autoSync = document.getElementById('autoSync');
      const bidirectionalSync = document.getElementById('bidirectionalSync');
      const retryFailedSync = document.getElementById('retryFailedSync');
      const testIntegration = document.getElementById('testIntegration');
      const integrationIndicator = document.getElementById('integrationIndicator');
      const integrationStatusText = document.getElementById('integrationStatusText');
      
      // Elementos del bot
      const retryCount = document.getElementById('retryCount');
      const responseTimeout = document.getElementById('responseTimeout');
      const cancelPolicy = document.getElementById('cancelPolicy');
      const useName = document.getElementById('useName');
      const sendReminders = document.getElementById('sendReminders');
      const logConversations = document.getElementById('logConversations');
      
      // Elementos de horarios
      const slot1start = document.getElementById('slot1start');
      const slot1end = document.getElementById('slot1end');
      const slot2start = document.getElementById('slot2start');
      const slot2end = document.getElementById('slot2end');
      const excludedDates = document.getElementById('excludedDates');
      const includeWeekends = document.getElementById('includeWeekends');
      const dynamicSlots = document.getElementById('dynamicSlots');
      
      // Elementos de notificaciones
      const reminderTime = document.getElementById('reminderTime');
      const adminEmail = document.getElementById('adminEmail');
      const emailNotifications = document.getElementById('emailNotifications');
      const smsNotifications = document.getElementById('smsNotifications');
      const webhookNotifications = document.getElementById('webhookNotifications');
      
      // Configuración por defecto
      const defaultConfig = {
        // Integración
        apiEndpoint: 'https://api.sistema-citas.com/v1',
        apiKey: 'sk-demo-key-12345',
        syncInterval: 5,
        autoSync: true,
        bidirectionalSync: true,
        retryFailedSync: false,
        
        // Bot
        retryCount: 5,
        responseTimeout: 30,
        cancelPolicy: 'Cancelación sin coste hasta 24 horas antes de la cita programada.',
        useName: true,
        sendReminders: true,
        logConversations: false,
        
        // Horarios
        slot1start: '09:00',
        slot1end: '12:00',
        slot2start: '14:00',
        slot2end: '18:00',
        excludedDates: '',
        includeWeekends: false,
        dynamicSlots: true,
        
        // Notificaciones
        reminderTime: 24,
        adminEmail: '',
        emailNotifications: true,
        smsNotifications: false,
        webhookNotifications: false
      };
      
      // Cargar configuración
      function loadSettings() {
        const config = JSON.parse(localStorage.getItem('bot_full_config') || JSON.stringify(defaultConfig));
        
        // Integración
        apiEndpoint.value = config.apiEndpoint || defaultConfig.apiEndpoint;
        apiKey.value = config.apiKey || defaultConfig.apiKey;
        syncInterval.value = config.syncInterval || defaultConfig.syncInterval;
        autoSync.checked = config.autoSync !== undefined ? config.autoSync : defaultConfig.autoSync;
        bidirectionalSync.checked = config.bidirectionalSync !== undefined ? config.bidirectionalSync : defaultConfig.bidirectionalSync;
        retryFailedSync.checked = config.retryFailedSync !== undefined ? config.retryFailedSync : defaultConfig.retryFailedSync;
        
        // Bot
        retryCount.value = config.retryCount || defaultConfig.retryCount;
        responseTimeout.value = config.responseTimeout || defaultConfig.responseTimeout;
        cancelPolicy.value = config.cancelPolicy || defaultConfig.cancelPolicy;
        useName.checked = config.useName !== undefined ? config.useName : defaultConfig.useName;
        sendReminders.checked = config.sendReminders !== undefined ? config.sendReminders : defaultConfig.sendReminders;
        logConversations.checked = config.logConversations !== undefined ? config.logConversations : defaultConfig.logConversations;
        
        // Horarios
        slot1start.value = config.slot1start || defaultConfig.slot1start;
        slot1end.value = config.slot1end || defaultConfig.slot1end;
        slot2start.value = config.slot2start || defaultConfig.slot2start;
        slot2end.value = config.slot2end || defaultConfig.slot2end;
        excludedDates.value = config.excludedDates || defaultConfig.excludedDates;
        includeWeekends.checked = config.includeWeekends !== undefined ? config.includeWeekends : defaultConfig.includeWeekends;
        dynamicSlots.checked = config.dynamicSlots !== undefined ? config.dynamicSlots : defaultConfig.dynamicSlots;
        
        // Notificaciones
        reminderTime.value = config.reminderTime || defaultConfig.reminderTime;
        adminEmail.value = config.adminEmail || defaultConfig.adminEmail;
        emailNotifications.checked = config.emailNotifications !== undefined ? config.emailNotifications : defaultConfig.emailNotifications;
        smsNotifications.checked = config.smsNotifications !== undefined ? config.smsNotifications : defaultConfig.smsNotifications;
        webhookNotifications.checked = config.webhookNotifications !== undefined ? config.webhookNotifications : defaultConfig.webhookNotifications;
        
        updateIntegrationStatus();
      }
      
      // Guardar configuración
      function saveSettings() {
        const config = {
          // Integración
          apiEndpoint: apiEndpoint.value.trim(),
          apiKey: apiKey.value.trim(),
          syncInterval: parseInt(syncInterval.value),
          autoSync: autoSync.checked,
          bidirectionalSync: bidirectionalSync.checked,
          retryFailedSync: retryFailedSync.checked,
          
          // Bot
          retryCount: Math.max(1, parseInt(retryCount.value || '5')),
          responseTimeout: Math.max(5, parseInt(responseTimeout.value || '30')),
          cancelPolicy: cancelPolicy.value.trim(),
          useName: useName.checked,
          sendReminders: sendReminders.checked,
          logConversations: logConversations.checked,
          
          // Horarios
          slot1start: slot1start.value.trim(),
          slot1end: slot1end.value.trim(),
          slot2start: slot2start.value.trim(),
          slot2end: slot2end.value.trim(),
          excludedDates: excludedDates.value.trim(),
          includeWeekends: includeWeekends.checked,
          dynamicSlots: dynamicSlots.checked,
          
          // Notificaciones
          reminderTime: parseInt(reminderTime.value),
          adminEmail: adminEmail.value.trim(),
          emailNotifications: emailNotifications.checked,
          smsNotifications: smsNotifications.checked,
          webhookNotifications: webhookNotifications.checked
        };
        
        // Guardar en localStorage
        localStorage.setItem('bot_full_config', JSON.stringify(config));
        
        // Mantener compatibilidad con configuración anterior
        localStorage.setItem('bot_retry_count', config.retryCount.toString());
        localStorage.setItem('bot_cancel_policy', config.cancelPolicy);
        localStorage.setItem('bot_use_client_name', config.useName ? 'true' : 'false');
        
        const slots = [
          { start: config.slot1start, end: config.slot1end },
          { start: config.slot2start, end: config.slot2end }
        ];
        localStorage.setItem('bot_slots', JSON.stringify(slots));
        
        showMessage('Configuración guardada correctamente.', 'success');
      }
      
      // Restablecer configuración
      function resetSettings() {
        localStorage.removeItem('bot_full_config');
        localStorage.removeItem('bot_retry_count');
        localStorage.removeItem('bot_slots');
        localStorage.removeItem('bot_cancel_policy');
        localStorage.removeItem('bot_use_client_name');
        
        loadSettings();
        showMessage('Configuración restablecida a valores por defecto.', 'success');
      }
      
      // Probar conexión
      function testConnection() {
        const originalText = testIntegration.innerHTML;
        testIntegration.innerHTML = '🔄 Probando conexión...';
        testIntegration.disabled = true;
        
        // Simular prueba de conexión
        setTimeout(() => {
          const isValid = apiEndpoint.value.includes('http') && apiKey.value.length > 10;
          
          if (isValid) {
            testIntegration.innerHTML = '✅ Conexión exitosa';
            updateIntegrationStatus(true);
            showMessage('Conexión establecida correctamente con el sistema externo.', 'success');
          } else {
            testIntegration.innerHTML = '❌ Conexión fallida';
            updateIntegrationStatus(false);
            showMessage('Error de conexión. Verifica la URL y clave de API.', 'error');
          }
          
          setTimeout(() => {
            testIntegration.innerHTML = originalText;
            testIntegration.disabled = false;
          }, 3000);
        }, 2000);
      }
      
      // Actualizar estado de integración
      function updateIntegrationStatus(connected) {
        if (connected === undefined) {
          connected = apiEndpoint.value.includes('http') && apiKey.value.length > 10;
        }
        
        if (connected) {
          integrationIndicator.className = 'status-indicator status-connected';
          integrationStatusText.textContent = 'Conectado al sistema de citas';
        } else {
          integrationIndicator.className = 'status-indicator status-disconnected';
          integrationStatusText.textContent = 'Sin conexión al sistema externo';
        }
      }
      
      // Mostrar mensaje
      function showMessage(text, type = 'success') {
        msg.textContent = text;
        msg.className = `msg ${type}`;
        
        setTimeout(() => {
          msg.textContent = '';
          msg.className = 'msg';
        }, 5000);
      }
      
      // Event listeners
      document.getElementById('btnSave').addEventListener('click', saveSettings);
      document.getElementById('btnReset').addEventListener('click', resetSettings);
      testIntegration.addEventListener('click', testConnection);
      
      // Monitorear cambios en campos de integración
      apiEndpoint.addEventListener('input', () => updateIntegrationStatus());
      apiKey.addEventListener('input', () => updateIntegrationStatus());
      
      // Cargar configuración al iniciar
      loadSettings();
    })();
  </script>
</body>
</html>