# üöÄ Bot de Citas CLARITY - Sistema Avanzado

Sistema empresarial de gesti√≥n de citas para instalaciones de fibra √≥ptica con interfaz conversacional multiling√ºe, dashboard administrativo en tiempo real y arquitectura escalable.

## üåü Caracter√≠sticas Principales

### ü§ñ Bot Conversacional Avanzado
- **Multiling√ºe**: Soporte completo para Espa√±ol, Alem√°n e Ingl√©s
- **State Machine**: Gesti√≥n robusta del flujo conversacional
- **Validaciones**: Error handling y recuperaci√≥n autom√°tica
- **Persistencia**: Almacenamiento completo de conversaciones

### üìÖ Gesti√≥n Inteligente de Citas
- **Horarios din√°micos**: Configuraci√≥n flexible por d√≠as de la semana
- **Asignaci√≥n autom√°tica**: T√©cnicos asignados por zona geogr√°fica
- **Recordatorios**: Sistema automatizado de notificaciones
- **Cancelaciones**: Pol√≠tica de cancelaci√≥n configurable
- **Exportaci√≥n**: Archivos .ICS para calendarios

### üéõÔ∏è Panel Administrativo
- **Monitoreo en tiempo real**: WebSocket para actualizaciones live
- **Estad√≠sticas completas**: KPIs de rendimiento y satisfacci√≥n
- **Gesti√≥n de sesiones**: Vista detallada de conversaciones activas
- **Exportaci√≥n de datos**: Excel, JSON y CSV
- **Dashboard visual**: Gr√°ficos interactivos con Chart.js

### üóÉÔ∏è Persistencia de Datos
- **Excel nativo**: Almacenamiento con formato y colores
- **Backup autom√°tico**: Copias de seguridad programadas
- **Google Sheets**: Integraci√≥n opcional
- **Base de datos**: Preparado para PostgreSQL/MongoDB

### üîß Arquitectura Empresarial
- **Node.js + Express**: Backend escalable y robusto
- **Socket.IO**: Comunicaci√≥n en tiempo real
- **Configuraci√≥n modular**: Sistema de configuraci√≥n flexible
- **Logging avanzado**: Winston para monitoreo de producci√≥n
- **Seguridad**: Helmet, CORS, rate limiting

## üöÄ Instalaci√≥n R√°pida

### Prerrequisitos
- Node.js >= 16.0.0
- npm >= 8.0.0

### Configuraci√≥n

1. **Clonar el repositorio**
```bash
git clone https://github.com/EsneiderCode/botcitas-demo.git
cd botcitas-demo
```

2. **Instalar dependencias**
```bash
npm install
```

3. **Configurar el sistema**
```bash
cp config/config.example.js config/config.js
```

4. **Personalizar configuraci√≥n**
Editar `config/config.js` con tus par√°metros:
- Datos de la empresa
- Horarios disponibles
- T√©cnicos y zonas
- Configuraci√≥n de idiomas

5. **Iniciar el servidor**
```bash
npm start
# o para desarrollo
npm run dev
```

6. **Abrir en navegador**
```
http://localhost:3000
```

## üìÅ Estructura del Proyecto

```
botcitas-demo/
‚îú‚îÄ‚îÄ üîß config/                    # Configuraci√≥n del sistema
‚îÇ   ‚îú‚îÄ‚îÄ config.example.js         # Plantilla de configuraci√≥n
‚îÇ   ‚îî‚îÄ‚îÄ config.js                 # Configuraci√≥n personalizada (crear)
‚îú‚îÄ‚îÄ üóÉÔ∏è data/                      # Datos y backups
‚îÇ   ‚îî‚îÄ‚îÄ appointments.xlsx          # Base de datos principal
‚îú‚îÄ‚îÄ üß© modules/                   # M√≥dulos del sistema
‚îÇ   ‚îú‚îÄ‚îÄ conversationsManager.js   # Gesti√≥n de conversaciones
‚îÇ   ‚îî‚îÄ‚îÄ dataManager.js            # Persistencia de datos
‚îú‚îÄ‚îÄ üé® css/                       # Estilos de la interfaz
‚îÇ   ‚îî‚îÄ‚îÄ styles.css                # Estilos principales
‚îú‚îÄ‚îÄ ‚ö° js/                        # Scripts del cliente
‚îÇ   ‚îú‚îÄ‚îÄ app.js                    # Motor conversacional
‚îÇ   ‚îú‚îÄ‚îÄ flows.js                  # Flujos de conversaci√≥n
‚îÇ   ‚îî‚îÄ‚îÄ i18n.js                   # Internacionalizaci√≥n
‚îú‚îÄ‚îÄ üìÇ ics/                       # Archivos de calendario
‚îú‚îÄ‚îÄ üåê HTML Pages                 # Interfaces web
‚îÇ   ‚îú‚îÄ‚îÄ index.html                # P√°gina principal
‚îÇ   ‚îú‚îÄ‚îÄ conversations.html        # Demo conversacional
‚îÇ   ‚îú‚îÄ‚îÄ admin.html                # Panel administrativo
‚îÇ   ‚îú‚îÄ‚îÄ dashboard.html            # Dashboard de KPIs
‚îÇ   ‚îú‚îÄ‚îÄ manager.html              # Gestor de clientes
‚îÇ   ‚îî‚îÄ‚îÄ settings.html             # Configuraci√≥n
‚îú‚îÄ‚îÄ üöÄ server.js                  # Servidor principal
‚îú‚îÄ‚îÄ üì¶ package.json               # Dependencias y scripts
‚îî‚îÄ‚îÄ üìö README.md                  # Esta documentaci√≥n
```

## üéØ Gu√≠a de Uso

### 1. Demo Conversacional
**URL**: `http://localhost:3000/conversations.html`

- Simula la experiencia completa del bot
- Soporte multiling√ºe en tiempo real
- Flujo completo de agendamiento
- Generaci√≥n autom√°tica de archivos .ICS

### 2. Panel Administrativo
**URL**: `http://localhost:3000/admin.html`

- Monitoreo en tiempo real de conversaciones
- Estad√≠sticas de rendimiento
- Gesti√≥n de sesiones activas
- Exportaci√≥n de datos

### 3. Dashboard de KPIs
**URL**: `http://localhost:3000/dashboard.html`

- M√©tricas de cumplimiento
- Ocupaci√≥n por t√©cnico
- Satisfacci√≥n del cliente (NPS)
- Gr√°ficos interactivos

### 4. Gestor de Clientes
**URL**: `http://localhost:3000/manager.html`

- Carga masiva de clientes v√≠a CSV
- Filtros por proyecto, estado y ubicaci√≥n
- Lanzamiento directo de conversaciones
- Gesti√≥n bulk de citas

## üîå API REST

### Endpoints Principales

#### üîç Sistema
```http
GET /api/health           # Estado del sistema
GET /api/config           # Configuraci√≥n p√∫blica
GET /api/stats            # Estad√≠sticas completas
```

#### üí¨ Conversaciones
```http
POST /api/conversation    # Procesar mensaje
GET /api/conversation/:id # Obtener sesi√≥n
```

#### üìÖ Citas
```http
GET /api/appointments           # Listar citas (con filtros)
GET /api/appointments/:id       # Obtener cita espec√≠fica
PUT /api/appointments/:id       # Actualizar cita
DELETE /api/appointments/:id    # Cancelar cita
```

#### üìä Datos
```http
POST /api/export               # Exportar datos
GET /api/technicians           # T√©cnicos disponibles
GET /api/slots                 # Horarios disponibles
```

### Ejemplo de Uso de API

```javascript
// Procesar mensaje conversacional
const response = await fetch('/api/conversation', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    sessionId: 'user_12345',
    message: 'Hola, quiero agendar una cita',
    metadata: { userAgent: navigator.userAgent }
  })
});

const result = await response.json();
console.log(result.bot); // Respuesta del bot
console.log(result.quick); // Opciones r√°pidas
```

## üîß Configuraci√≥n Avanzada

### Personalizaci√≥n de Horarios
```javascript
// config/config.js
appointments: {
  availableSlots: {
    1: ['09:00', '11:00', '14:00', '16:00'], // Lunes
    2: ['09:00', '11:00', '14:00', '16:00'], // Martes
    // ... resto de la semana
  },
  slotDuration: 120, // 2 horas
  timezone: 'Europe/Berlin'
}
```

### Configuraci√≥n de T√©cnicos
```javascript
technicians: {
  'CLARITY-01': { 
    name: 'Miguel Garc√≠a', 
    zone: 'PLZ 29xxx', 
    active: true 
  },
  'CLARITY-02': { 
    name: 'Anna Schmidt', 
    zone: 'PLZ 30xxx', 
    active: true 
  }
  // ... m√°s t√©cnicos
}
```

### Personalizaci√≥n de Mensajes
Los mensajes est√°n centralizados en `modules/conversationsManager.js` en el m√©todo `getLocalizedMessage()`.

## üåê WebSocket Events

### Eventos del Cliente
```javascript
socket.emit('joinSession', sessionId);
socket.emit('chatMessage', { sessionId, message, metadata });
socket.emit('heartbeat');
```

### Eventos del Servidor
```javascript
socket.on('sessionCreated', session => { /* Nueva sesi√≥n */ });
socket.on('appointmentCreated', appointment => { /* Nueva cita */ });
socket.on('statsUpdate', stats => { /* Estad√≠sticas actualizadas */ });
socket.on('conversationUpdate', data => { /* Actividad de conversaci√≥n */ });
```

## üìä Formatos de Datos

### Estructura de Cita
```javascript
{
  id: "C-2025-0916-1300-ABC",
  sessionId: "session_xyz",
  customerName: "Mar√≠a Garc√≠a",
  phone: "+34 600 000 000",
  startTime: "2025-09-16T13:00:00+02:00",
  endTime: "2025-09-16T15:00:00+02:00",
  technician: "CLARITY-07",
  status: "confirmed", // pending, cancelled, completed
  language: "es",
  createdAt: "2025-09-05T20:30:00.000Z",
  reminderEnabled: true,
  notes: "Cliente prefiere llamada 1h antes"
}
```

### Estructura de Sesi√≥n
```javascript
{
  id: "session_12345",
  state: "CONFIRMATION",
  language: "es",
  startTime: "2025-09-05T20:30:00.000Z",
  lastActivity: "2025-09-05T20:35:00.000Z",
  context: {
    selectedSlot: { /* slot data */ },
    appointmentId: "C-2025-0916-1300-ABC",
    confirmed: true
  },
  messageHistory: [
    {
      timestamp: "2025-09-05T20:30:00.000Z",
      type: "user",
      content: "Hola",
      metadata: { /* metadata */ }
    }
  ],
  completed: false
}
```

## üîê Seguridad

### Medidas Implementadas
- **Helmet.js**: Headers de seguridad HTTP
- **CORS**: Control de origen cruzado
- **Rate Limiting**: Limitaci√≥n de requests por IP
- **Input Sanitization**: Prevenci√≥n de XSS
- **Session Management**: Gesti√≥n segura de sesiones

### Variables de Entorno
```bash
# .env
NODE_ENV=production
PORT=3000
HOST=localhost
DATABASE_URL=postgresql://user:pass@localhost/db
CORS_ORIGIN=https://yourdomain.com
LOG_LEVEL=info
```

## üìà Monitoreo y Logging

### Logs del Sistema
Los logs se guardan en `./logs/app.log` con rotaci√≥n autom√°tica:

```bash
tail -f logs/app.log  # Seguir logs en tiempo real
```

### M√©tricas de Rendimiento
- **Tiempo de respuesta**: Medici√≥n autom√°tica de latencia
- **Uso de memoria**: Monitoreo de recursos del sistema
- **Conexiones activas**: Tracking de usuarios simult√°neos
- **Tasa de conversi√≥n**: Conversaciones ‚Üí Citas confirmadas

## üöÄ Despliegue en Producci√≥n

### Docker (Recomendado)
```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
EXPOSE 3000
CMD ["npm", "start"]
```

### PM2 (Alternativo)
```bash
npm install -g pm2
pm2 start server.js --name "botcitas-clarity"
pm2 startup
pm2 save
```

### Variables de Producci√≥n
```bash
export NODE_ENV=production
export PORT=3000
export HOST=0.0.0.0
export LOG_LEVEL=warn
```

## ü§ù Contribuci√≥n

1. **Fork** el repositorio
2. **Crear** rama para tu feature: `git checkout -b feature/nueva-funcionalidad`
3. **Commit** tus cambios: `git commit -m 'A√±adir nueva funcionalidad'`
4. **Push** a la rama: `git push origin feature/nueva-funcionalidad`
5. **Abrir** un Pull Request

## üìù Changelog

### v2.0.0 (2025-09-05)
- ‚ú® **Nuevo**: Sistema de gesti√≥n de conversaciones con State Machine
- ‚ú® **Nuevo**: Panel administrativo en tiempo real
- ‚ú® **Nuevo**: Persistencia avanzada con Excel y backups
- ‚ú® **Nuevo**: API REST completa
- ‚ú® **Nuevo**: WebSocket para comunicaci√≥n en tiempo real
- ‚ú® **Nuevo**: Dashboard de KPIs con gr√°ficos interactivos
- üîß **Mejorado**: Arquitectura modular y escalable
- üîß **Mejorado**: Manejo de errores robusto
- üîß **Mejorado**: Dise√±o responsive mejorado
- üîß **Mejorado**: Navegaci√≥n unificada entre p√°ginas

### v1.0.0
- üöÄ **Inicial**: Demo b√°sico de conversaciones
- üöÄ **Inicial**: Funcionalidad de agendamiento
- üöÄ **Inicial**: Soporte multiling√ºe b√°sico

## üìÑ Licencia

MIT License - Ver [LICENSE](LICENSE) para m√°s detalles.

## üÜò Soporte

- **Documentaci√≥n**: Este README
- **Issues**: [GitHub Issues](https://github.com/EsneiderCode/botcitas-demo/issues)
- **Discusiones**: [GitHub Discussions](https://github.com/EsneiderCode/botcitas-demo/discussions)

## üôè Agradecimientos

- **Deutsche Glasfaser**: Cliente objetivo del sistema
- **CLARITY Team**: Desarrollo e implementaci√≥n
- **Comunidad Open Source**: Librer√≠as y herramientas utilizadas

---

**üí° Tip**: Para obtener el m√°ximo rendimiento, usa Node.js 18+ y aseg√∫rate de configurar correctamente las variables de entorno para producci√≥n.

**üîó Links √ötiles**:
- [Chart.js Documentation](https://www.chartjs.org/docs/)
- [Socket.IO Guide](https://socket.io/docs/)
- [ExcelJS Documentation](https://github.com/exceljs/exceljs)
- [Moment.js Documentation](https://momentjs.com/docs/)

**üìß Contacto**: Para consultas empresariales o personalizaciones, contactar al equipo de desarrollo.